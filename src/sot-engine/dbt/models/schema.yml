version: 2

sources:
  - name: lz
    schema: main
    tables:
      - name: lz_tool_runs
      - name: lz_collection_runs
      - name: lz_layout_files
      - name: lz_layout_directories
      - name: lz_scc_file_metrics
      - name: lz_lizard_file_metrics
      - name: lz_lizard_function_metrics
      - name: lz_semgrep_smells
      - name: lz_roslyn_violations
      - name: lz_sonarqube_issues
      - name: lz_sonarqube_metrics
      - name: lz_trivy_vulnerabilities
      - name: lz_trivy_targets
      - name: lz_trivy_iac_misconfigs
      - name: lz_git_sizer_metrics
      - name: lz_git_sizer_violations
      - name: lz_git_sizer_lfs_candidates
      - name: lz_gitleaks_secrets
      - name: lz_code_symbols
      - name: lz_symbol_calls
      - name: lz_file_imports
      - name: lz_scancode_file_licenses
      - name: lz_scancode_summary
      - name: lz_pmd_cpd_file_metrics
      - name: lz_pmd_cpd_duplications
      - name: lz_pmd_cpd_occurrences
      - name: lz_devskim_findings
      - name: lz_dotcover_assembly_coverage
      - name: lz_dotcover_type_coverage
      - name: lz_dotcover_method_coverage
      - name: lz_dependensee_projects
      - name: lz_dependensee_project_refs
      - name: lz_dependensee_package_refs
      - name: lz_git_fame_authors
      - name: lz_git_fame_summary

models:
  - name: stg_lz_tool_runs
    columns:
      - name: run_pk
        tests:
          - not_null
          - unique
      - name: collection_run_id
        tests:
          - not_null
          - relationships:
              to: source('lz', 'lz_collection_runs')
              field: collection_run_id
      - name: repo_id
        tests:
          - not_null
      - name: run_id
        tests:
          - not_null
      - name: tool_name
        tests:
          - not_null
      - name: commit
        tests:
          - not_null

  - name: stg_lz_layout_files
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null

  - name: stg_lz_layout_directories
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null

  - name: stg_lz_scc_file_metrics
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null

  - name: stg_lz_lizard_file_metrics
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null

  - name: stg_lz_lizard_function_metrics
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: function_name
        tests:
          - not_null
      - name: line_start
        tests:
          - not_null

  - name: rollup_scc_directory_recursive_distributions
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - lines_total
                  - code_lines
                  - comment_lines
                  - blank_lines
                  - complexity
      - name: value_count
        tests:
          - not_null

  - name: rollup_scc_directory_direct_distributions
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - lines_total
                  - code_lines
                  - comment_lines
                  - blank_lines
                  - complexity
      - name: value_count
        tests:
          - not_null

  - name: rollup_scc_directory_counts_direct
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_lines
        tests:
          - not_null
      - name: total_code_lines
        tests:
          - not_null
      - name: total_complexity
        tests:
          - not_null

  - name: rollup_scc_directory_counts_recursive
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_lines
        tests:
          - not_null
      - name: total_code_lines
        tests:
          - not_null
      - name: total_complexity
        tests:
          - not_null

  - name: rollup_lizard_directory_recursive_distributions
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - nloc
                  - total_ccn
                  - avg_ccn
                  - max_ccn
      - name: value_count
        tests:
          - not_null

  - name: rollup_lizard_directory_direct_distributions
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - nloc
                  - total_ccn
                  - avg_ccn
                  - max_ccn
      - name: value_count
        tests:
          - not_null

  - name: rollup_lizard_directory_counts_direct
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_nloc
        tests:
          - not_null
      - name: total_function_count
        tests:
          - not_null
      - name: total_ccn
        tests:
          - not_null

  - name: rollup_lizard_directory_counts_recursive
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_nloc
        tests:
          - not_null
      - name: total_function_count
        tests:
          - not_null
      - name: total_ccn
        tests:
          - not_null

  - name: unified_file_metrics
    description: "Unified file-level metrics combining scc, lizard, and symbol-scanner"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: loc_total
        tests:
          - not_null
      - name: symbol_run_pk
        description: "Symbol-scanner tool run primary key (null if not available)"
        tests:
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: symbol_count
        description: "Number of symbols defined in file"
      - name: function_count
        description: "Number of functions defined in file"
      - name: class_count
        description: "Number of classes defined in file"
      - name: call_count
        description: "Number of outgoing function calls"
      - name: import_count
        description: "Number of file imports"
      - name: roslyn_run_pk
        description: "Roslyn analyzers tool run primary key (null if not available)"
        tests:
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: roslyn_violation_count
        description: "Total count of Roslyn analyzer violations in file"
      - name: roslyn_severity_critical
        description: "Count of CRITICAL severity violations"
      - name: roslyn_severity_high
        description: "Count of HIGH severity violations"
      - name: roslyn_severity_medium
        description: "Count of MEDIUM severity violations"
      - name: roslyn_severity_low
        description: "Count of LOW severity violations"
      - name: roslyn_severity_info
        description: "Count of INFO severity violations"
      - name: roslyn_severity_high_plus
        description: "Count of CRITICAL + HIGH severity violations"
      - name: semgrep_smell_count
        description: "Total count of Semgrep code smells in file"
      - name: semgrep_severity_critical
        description: "Count of CRITICAL severity smells"
      - name: semgrep_severity_high
        description: "Count of HIGH severity smells"
      - name: semgrep_severity_medium
        description: "Count of MEDIUM severity smells"
      - name: semgrep_severity_low
        description: "Count of LOW severity smells"
      - name: semgrep_severity_info
        description: "Count of INFO severity smells"
      - name: semgrep_severity_high_plus
        description: "Count of CRITICAL + HIGH severity smells"
      - name: devskim_run_pk
        description: "DevSkim tool run primary key (null if not available)"
        tests:
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: devskim_issue_count
        description: "Total count of DevSkim security issues in file"
      - name: devskim_severity_critical
        description: "Count of CRITICAL severity issues"
      - name: devskim_severity_high
        description: "Count of HIGH severity issues"
      - name: devskim_severity_medium
        description: "Count of MEDIUM severity issues"
      - name: devskim_severity_low
        description: "Count of LOW severity issues"
      - name: devskim_severity_high_plus
        description: "Count of CRITICAL + HIGH severity issues"
      - name: sonarqube_run_pk
        description: "SonarQube tool run primary key (null if not available)"
        tests:
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: sonarqube_issue_count
        description: "Total count of SonarQube issues in file"
      - name: sonarqube_type_bug
        description: "Count of BUG type issues"
      - name: sonarqube_type_vulnerability
        description: "Count of VULNERABILITY type issues"
      - name: sonarqube_type_code_smell
        description: "Count of CODE_SMELL type issues"
      - name: sonarqube_type_security_hotspot
        description: "Count of SECURITY_HOTSPOT type issues"
      - name: sonarqube_severity_blocker
        description: "Count of BLOCKER severity issues"
      - name: sonarqube_severity_critical
        description: "Count of CRITICAL severity issues"
      - name: sonarqube_severity_major
        description: "Count of MAJOR severity issues"
      - name: sonarqube_severity_minor
        description: "Count of MINOR severity issues"
      - name: sonarqube_severity_info
        description: "Count of INFO severity issues"
      - name: sonarqube_severity_high_plus
        description: "Count of BLOCKER + CRITICAL severity issues"
      - name: sonarqube_cognitive_complexity
        description: "SonarQube cognitive complexity score"
      - name: sonarqube_duplicated_lines
        description: "Number of duplicated lines detected by SonarQube"
      - name: sonarqube_duplicated_lines_density
        description: "Percentage of duplicated lines"
      - name: gitleaks_run_pk
        description: "Gitleaks tool run primary key (null if not available)"
        tests:
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: gitleaks_secret_count
        description: "Total count of secrets detected in file"
      - name: gitleaks_severity_critical
        description: "Count of CRITICAL severity secrets"
      - name: gitleaks_severity_high
        description: "Count of HIGH severity secrets"
      - name: gitleaks_severity_medium
        description: "Count of MEDIUM severity secrets"
      - name: gitleaks_severity_low
        description: "Count of LOW severity secrets"
      - name: gitleaks_severity_high_plus
        description: "Count of CRITICAL + HIGH severity secrets"
      - name: gitleaks_secrets_in_head
        description: "Count of secrets present in current HEAD"
      - name: gitleaks_secrets_in_history
        description: "Count of secrets only in git history (not in HEAD)"
      - name: gitleaks_unique_rule_count
        description: "Count of distinct gitleaks rules that matched"
      - name: gitleaks_avg_entropy
        description: "Average entropy of detected secrets"
      - name: gitleaks_max_entropy
        description: "Maximum entropy of detected secrets"
      - name: trivy_run_pk
        description: "Trivy tool run primary key (null if not available)"
        tests:
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: trivy_vulnerability_count
        description: "Total count of vulnerabilities in file"
      - name: trivy_vuln_critical
        description: "Count of CRITICAL severity vulnerabilities"
      - name: trivy_vuln_high
        description: "Count of HIGH severity vulnerabilities"
      - name: trivy_vuln_medium
        description: "Count of MEDIUM severity vulnerabilities"
      - name: trivy_vuln_low
        description: "Count of LOW severity vulnerabilities"
      - name: trivy_iac_misconfig_count
        description: "Total count of IaC misconfigurations in file"
      - name: trivy_iac_critical
        description: "Count of CRITICAL severity IaC misconfigurations"
      - name: trivy_iac_high
        description: "Count of HIGH severity IaC misconfigurations"
      - name: trivy_iac_medium
        description: "Count of MEDIUM severity IaC misconfigurations"
      - name: trivy_iac_low
        description: "Count of LOW severity IaC misconfigurations"
      - name: trivy_total_finding_count
        description: "Total count of all trivy findings (vulnerabilities + IaC misconfigs)"
      - name: trivy_severity_high_plus
        description: "Count of CRITICAL + HIGH severity findings (vulns + IaC)"
      - name: scancode_run_pk
        description: "Scancode tool run primary key (null if not available)"
      - name: scancode_license_count
        description: "Total count of licenses detected in file"
      - name: scancode_cat_copyleft
        description: "Count of copyleft licenses detected"
      - name: scancode_cat_permissive
        description: "Count of permissive licenses detected"
      - name: scancode_cat_weak_copyleft
        description: "Count of weak-copyleft licenses detected"
      - name: scancode_cat_unknown
        description: "Count of unknown category licenses detected"
      - name: scancode_match_file
        description: "Count of file-level license matches"
      - name: scancode_match_header
        description: "Count of header-level license matches"
      - name: scancode_match_spdx
        description: "Count of SPDX license matches"
      - name: scancode_avg_confidence
        description: "Average confidence score of license detections"
      - name: pmd_cpd_run_pk
        description: "PMD-CPD tool run primary key (null if not available)"
      - name: pmd_cpd_duplicate_lines
        description: "Number of duplicate lines in file"
      - name: pmd_cpd_duplicate_blocks
        description: "Number of duplicate code blocks in file"
      - name: pmd_cpd_duplication_percentage
        description: "Percentage of file that is duplicated code"

  - name: unified_run_summary
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: collection_run_id
        tests:
          - not_null
          - relationships:
              to: source('lz', 'lz_collection_runs')
              field: collection_run_id
      - name: repo_id
        tests:
          - not_null
      - name: run_id
        tests:
          - not_null
      - name: total_files
        tests:
          - not_null

  - name: stg_lz_semgrep_smells
    description: "Staged Semgrep code smell findings"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: rule_id
        tests:
          - not_null
      - name: severity
        tests:
          - not_null

  - name: stg_semgrep_file_metrics
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: smell_count
        tests:
          - not_null

  - name: rollup_semgrep_directory_counts_recursive
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_smell_count
        tests:
          - not_null

  - name: rollup_semgrep_directory_counts_direct
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_smell_count
        tests:
          - not_null

  - name: rollup_semgrep_directory_recursive_distributions
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - smell_count
                  - severity_high_plus
      - name: value_count
        tests:
          - not_null

  - name: rollup_semgrep_directory_direct_distributions
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - smell_count
                  - severity_high_plus
      - name: value_count
        tests:
          - not_null

  - name: stg_lz_roslyn_violations
    description: "Staged Roslyn analyzer violations - individual findings"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: rule_id
        tests:
          - not_null
      - name: severity
        tests:
          - not_null

  - name: stg_roslyn_file_metrics
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: violation_count
        tests:
          - not_null

  - name: rollup_roslyn_directory_counts_recursive
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_violation_count
        tests:
          - not_null

  - name: rollup_roslyn_directory_counts_direct
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_violation_count
        tests:
          - not_null

  - name: rollup_roslyn_directory_recursive_distributions
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
      - name: value_count
        tests:
          - not_null

  - name: rollup_roslyn_directory_direct_distributions
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
      - name: value_count
        tests:
          - not_null

  - name: stg_sonarqube_issues
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: issue_key
        tests:
          - not_null
      - name: rule_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null

  - name: stg_sonarqube_file_metrics
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: issue_count
        tests:
          - not_null

  - name: rollup_sonarqube_directory_counts_direct
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_issue_count
        tests:
          - not_null

  - name: rollup_sonarqube_directory_counts_recursive
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_issue_count
        tests:
          - not_null

  - name: rollup_sonarqube_directory_direct_distributions
    description: "Distribution statistics for SonarQube metrics (direct scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - issue_count
                  - severity_high_plus
                  - ncloc
                  - complexity
                  - cognitive_complexity
      - name: value_count
        tests:
          - not_null

  - name: rollup_sonarqube_directory_recursive_distributions
    description: "Distribution statistics for SonarQube metrics (recursive scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - issue_count
                  - severity_high_plus
                  - ncloc
                  - complexity
                  - cognitive_complexity
      - name: value_count
        tests:
          - not_null

  - name: stg_trivy_vulnerabilities
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: target_key
        tests:
          - not_null
      - name: vulnerability_id
        tests:
          - not_null
      - name: package_name
        tests:
          - not_null

  - name: stg_trivy_targets
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: target_key
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null

  - name: stg_trivy_iac_misconfigs
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: relative_path
        tests:
          - not_null
      - name: misconfig_id
        tests:
          - not_null

  - name: stg_trivy_target_metrics
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: target_key
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: vulnerability_count
        tests:
          - not_null

  - name: stg_trivy_file_metrics
    description: "File-level aggregation of trivy findings combining vulnerabilities and IaC misconfigurations"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: vulnerability_count
        tests:
          - not_null
      - name: iac_misconfig_count
        tests:
          - not_null
      - name: total_finding_count
        tests:
          - not_null
      - name: severity_high_plus
        tests:
          - not_null

  - name: rollup_trivy_directory_counts_direct
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: total_vulnerability_count
        tests:
          - not_null
      - name: total_iac_misconfig_count
        tests:
          - not_null

  - name: rollup_trivy_directory_counts_recursive
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: total_vulnerability_count
        tests:
          - not_null
      - name: total_iac_misconfig_count
        tests:
          - not_null

  - name: rollup_trivy_combined_directory_counts_direct
    description: "Combined Trivy file metrics (vulns + IaC) per directory (direct scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: tool_run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: files_with_vulns
        tests:
          - not_null
      - name: files_with_iac_misconfigs
        tests:
          - not_null
      - name: total_vulnerability_count
        tests:
          - not_null
      - name: total_iac_misconfig_count
        tests:
          - not_null
      - name: total_finding_count
        tests:
          - not_null
      - name: total_severity_high_plus
        tests:
          - not_null

  - name: rollup_trivy_combined_directory_counts_recursive
    description: "Combined Trivy file metrics (vulns + IaC) per directory (recursive scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: tool_run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: files_with_vulns
        tests:
          - not_null
      - name: files_with_iac_misconfigs
        tests:
          - not_null
      - name: total_vulnerability_count
        tests:
          - not_null
      - name: total_iac_misconfig_count
        tests:
          - not_null
      - name: total_finding_count
        tests:
          - not_null
      - name: total_severity_high_plus
        tests:
          - not_null

  - name: rollup_trivy_combined_directory_direct_distributions
    description: "Distribution statistics for combined Trivy metrics (direct scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - vulnerability_count
                  - iac_misconfig_count
                  - total_finding_count
                  - severity_high_plus
      - name: value_count
        tests:
          - not_null

  - name: rollup_trivy_combined_directory_recursive_distributions
    description: "Distribution statistics for combined Trivy metrics (recursive scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - vulnerability_count
                  - iac_misconfig_count
                  - total_finding_count
                  - severity_high_plus
      - name: value_count
        tests:
          - not_null

  - name: stg_lz_git_sizer_metrics
    description: Repository-level health metrics from git-sizer
    columns:
      - name: run_pk
        tests:
          - not_null
          - unique
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: repo_id
        tests:
          - not_null
      - name: health_grade
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['A', 'A+', 'B', 'B+', 'C', 'C+', 'D', 'D+', 'F']

  - name: stg_lz_git_sizer_violations
    description: Threshold violations detected by git-sizer
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: metric
        tests:
          - not_null
      - name: level
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: [1, 2, 3, 4]

  - name: stg_lz_git_sizer_lfs_candidates
    description: Files recommended for Git LFS migration
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_path
        tests:
          - not_null

  - name: stg_lz_gitleaks_secrets
    description: "Staged secret detection findings from gitleaks"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: rule_id
        tests:
          - not_null
      - name: severity
        tests:
          - not_null

  - name: repo_health_summary
    description: Repository health combining git-sizer with file metrics
    columns:
      - name: run_pk
        tests:
          - not_null
          - unique
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: collection_run_id
        tests:
          - not_null
          - relationships:
              to: source('lz', 'lz_collection_runs')
              field: collection_run_id
      - name: health_grade
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: ['A', 'A+', 'B', 'B+', 'C', 'C+', 'D', 'D+', 'F']

  - name: stg_lz_code_symbols
    description: "Staged code symbols from symbol-scanner"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: symbol_name
        tests:
          - not_null
      - name: symbol_type
        tests:
          - not_null

  - name: stg_lz_symbol_calls
    description: "Staged symbol call relationships from symbol-scanner"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: caller_file_id
        tests:
          - not_null
      - name: callee_symbol
        tests:
          - not_null

  - name: stg_lz_file_imports
    description: "Staged file imports from symbol-scanner"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: imported_path
        tests:
          - not_null

  - name: stg_symbols_file_metrics
    description: "File-level aggregation of code symbols for distribution calculations"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: symbol_count
        tests:
          - not_null

  - name: stg_symbol_calls_file_metrics
    description: "File-level aggregation of symbol calls for distribution calculations"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: call_count
        tests:
          - not_null

  - name: stg_file_imports_file_metrics
    description: "File-level aggregation of imports for distribution calculations"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: import_count
        tests:
          - not_null

  - name: rollup_symbols_directory_direct_distributions
    description: "Distribution statistics for symbol metrics (direct scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - symbol_count
                  - function_count
                  - class_count
                  - exported_count
                  - avg_parameters
      - name: value_count
        tests:
          - not_null

  - name: rollup_symbols_directory_recursive_distributions
    description: "Distribution statistics for symbol metrics (recursive scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - symbol_count
                  - function_count
                  - class_count
                  - exported_count
                  - avg_parameters
      - name: value_count
        tests:
          - not_null

  - name: rollup_symbol_calls_directory_direct_distributions
    description: "Distribution statistics for symbol call metrics (direct scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - call_count
                  - distinct_callees
                  - distinct_callee_files
                  - direct_call_count
      - name: value_count
        tests:
          - not_null

  - name: rollup_symbol_calls_directory_recursive_distributions
    description: "Distribution statistics for symbol call metrics (recursive scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - call_count
                  - distinct_callees
                  - distinct_callee_files
                  - direct_call_count
      - name: value_count
        tests:
          - not_null

  - name: rollup_file_imports_directory_direct_distributions
    description: "Distribution statistics for file import metrics (direct scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - import_count
                  - unique_imports
                  - static_import_count
      - name: value_count
        tests:
          - not_null

  - name: rollup_file_imports_directory_recursive_distributions
    description: "Distribution statistics for file import metrics (recursive scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - import_count
                  - unique_imports
                  - static_import_count
      - name: value_count
        tests:
          - not_null

  - name: rollup_symbols_directory_counts_direct
    description: "Symbol counts per directory (direct scope - files in directory only)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: symbol_count
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: function_count
        tests:
          - not_null
      - name: class_count
        tests:
          - not_null
      - name: method_count
        tests:
          - not_null
      - name: exported_count
        tests:
          - not_null

  - name: rollup_symbols_directory_counts_recursive
    description: "Symbol counts per directory (recursive scope - includes subtree)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: symbol_count
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: function_count
        tests:
          - not_null
      - name: class_count
        tests:
          - not_null
      - name: method_count
        tests:
          - not_null
      - name: exported_count
        tests:
          - not_null

  - name: rollup_symbol_calls_directory_counts_direct
    description: "Symbol call counts per directory (direct scope - files in directory only)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_call_count
        tests:
          - not_null
      - name: total_distinct_callees
        tests:
          - not_null
      - name: total_distinct_callee_files
        tests:
          - not_null
      - name: total_direct_call_count
        tests:
          - not_null
      - name: total_dynamic_call_count
        tests:
          - not_null
      - name: total_async_call_count
        tests:
          - not_null

  - name: rollup_symbol_calls_directory_counts_recursive
    description: "Symbol call counts per directory (recursive scope - includes subtree)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_call_count
        tests:
          - not_null
      - name: total_distinct_callees
        tests:
          - not_null
      - name: total_distinct_callee_files
        tests:
          - not_null
      - name: total_direct_call_count
        tests:
          - not_null
      - name: total_dynamic_call_count
        tests:
          - not_null
      - name: total_async_call_count
        tests:
          - not_null

  - name: rollup_file_imports_directory_counts_direct
    description: "File import counts per directory (direct scope - files in directory only)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_import_count
        tests:
          - not_null
      - name: total_unique_imports
        tests:
          - not_null
      - name: total_static_import_count
        tests:
          - not_null
      - name: total_dynamic_import_count
        tests:
          - not_null
      - name: total_side_effect_import_count
        tests:
          - not_null

  - name: rollup_file_imports_directory_counts_recursive
    description: "File import counts per directory (recursive scope - includes subtree)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_import_count
        tests:
          - not_null
      - name: total_unique_imports
        tests:
          - not_null
      - name: total_static_import_count
        tests:
          - not_null
      - name: total_dynamic_import_count
        tests:
          - not_null
      - name: total_side_effect_import_count
        tests:
          - not_null

  - name: rollup_coupling_directory_metrics_direct
    description: "Coupling metrics per directory (direct - fan-in/fan-out for files directly in directory only)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: outgoing_calls
        description: "Total count of outgoing calls from files in this directory (may include duplicates)"
        tests:
          - not_null
      - name: distinct_callees
        description: "Count of distinct callee symbols called by files in this directory"
        tests:
          - not_null
      - name: fan_out
        description: "Count of distinct callee files that files in this directory call"
        tests:
          - not_null
      - name: fan_in
        description: "Count of distinct external caller files from OTHER directories calling into this directory (excludes internal calls)"
        tests:
          - not_null
      - name: direct_calls
        description: "Count of direct (non-dynamic, non-async) calls"
        tests:
          - not_null
      - name: dynamic_calls
        description: "Count of dynamic/late-bound calls"
        tests:
          - not_null
      - name: async_calls
        description: "Count of asynchronous calls"
        tests:
          - not_null
      - name: instability
        description: "fan_out / (fan_in + fan_out) - 0 = stable (many incoming deps), 1 = unstable (many outgoing deps)"
        tests:
          - not_null

  - name: rollup_coupling_directory_metrics_recursive
    description: "Coupling metrics per directory (recursive - includes all files in subtree, external means outside the subtree)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: outgoing_calls
        description: "Total count of outgoing calls from files in this subtree (may include duplicates)"
        tests:
          - not_null
      - name: distinct_callees
        description: "Count of distinct callee symbols called by files in this subtree"
        tests:
          - not_null
      - name: fan_out
        description: "Count of distinct callee files that files in this subtree call"
        tests:
          - not_null
      - name: fan_in
        description: "Count of distinct external caller files from OUTSIDE this subtree calling into this subtree (excludes internal calls)"
        tests:
          - not_null
      - name: direct_calls
        description: "Count of direct (non-dynamic, non-async) calls in this subtree"
        tests:
          - not_null
      - name: dynamic_calls
        description: "Count of dynamic/late-bound calls in this subtree"
        tests:
          - not_null
      - name: async_calls
        description: "Count of asynchronous calls in this subtree"
        tests:
          - not_null
      - name: instability
        description: "fan_out / (fan_in + fan_out) - 0 = stable (many incoming deps), 1 = unstable (many outgoing deps)"
        tests:
          - not_null

  - name: stg_lz_scancode_file_licenses
    description: "Staged license findings from scancode analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: spdx_id
        tests:
          - not_null
      - name: category
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - permissive
                  - weak-copyleft
                  - copyleft
                  - unknown
      - name: confidence
        tests:
          - not_null
      - name: match_type
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - file
                  - header
                  - spdx

  - name: stg_lz_scancode_summary
    description: "Repository-level license summary from scancode analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - unique
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: total_files_scanned
        tests:
          - not_null
      - name: files_with_licenses
        tests:
          - not_null
      - name: overall_risk
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - low
                  - medium
                  - high
                  - critical
                  - unknown
      - name: has_permissive
        tests:
          - not_null
      - name: has_weak_copyleft
        tests:
          - not_null
      - name: has_copyleft
        tests:
          - not_null
      - name: has_unknown
        tests:
          - not_null

  - name: stg_lz_pmd_cpd_file_metrics
    description: "Staged PMD-CPD file metrics from duplication analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: total_lines
        tests:
          - not_null
      - name: duplicate_lines
        tests:
          - not_null
      - name: duplicate_blocks
        tests:
          - not_null
      - name: duplication_percentage
        tests:
          - not_null

  - name: rollup_pmd_cpd_directory_counts_direct
    description: "PMD-CPD duplication counts per directory (direct scope - files in directory only)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_lines
        tests:
          - not_null
      - name: total_duplicate_lines
        tests:
          - not_null
      - name: total_duplicate_blocks
        tests:
          - not_null
      - name: avg_duplication_percentage
        tests:
          - not_null

  - name: rollup_pmd_cpd_directory_counts_recursive
    description: "PMD-CPD duplication counts per directory (recursive scope - includes subtree)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_lines
        tests:
          - not_null
      - name: total_duplicate_lines
        tests:
          - not_null
      - name: total_duplicate_blocks
        tests:
          - not_null
      - name: avg_duplication_percentage
        tests:
          - not_null

  - name: stg_lz_pmd_cpd_duplications
    description: "Staged PMD-CPD duplication clones"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: clone_id
        tests:
          - not_null
      - name: lines
        tests:
          - not_null
      - name: tokens
        tests:
          - not_null
      - name: occurrence_count
        tests:
          - not_null
      - name: is_cross_file
        tests:
          - not_null

  - name: stg_lz_pmd_cpd_occurrences
    description: "Staged PMD-CPD clone occurrences"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: clone_id
        tests:
          - not_null
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: line_start
        tests:
          - not_null
      - name: line_end
        tests:
          - not_null

  - name: rollup_pmd_cpd_directory_direct_distributions
    description: "Distribution statistics for PMD-CPD metrics (direct scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - duplicate_lines
                  - duplicate_blocks
                  - duplication_percentage
      - name: value_count
        tests:
          - not_null

  - name: rollup_pmd_cpd_directory_recursive_distributions
    description: "Distribution statistics for PMD-CPD metrics (recursive scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - duplicate_lines
                  - duplicate_blocks
                  - duplication_percentage
      - name: value_count
        tests:
          - not_null

  - name: stg_lz_devskim_findings
    description: "Staged DevSkim security findings"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: rule_id
        tests:
          - not_null

  - name: stg_devskim_file_metrics
    description: "File-level aggregation of DevSkim security findings"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: issue_count
        tests:
          - not_null

  - name: rollup_devskim_directory_counts_direct
    description: "DevSkim issue counts per directory (direct scope - files in directory only)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_issue_count
        tests:
          - not_null

  - name: rollup_devskim_directory_counts_recursive
    description: "DevSkim issue counts per directory (recursive scope - includes subtree)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_issue_count
        tests:
          - not_null

  - name: rollup_devskim_directory_direct_distributions
    description: "Distribution statistics for DevSkim security findings (direct scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - issue_count
                  - severity_high_plus
      - name: value_count
        tests:
          - not_null

  - name: rollup_devskim_directory_recursive_distributions
    description: "Distribution statistics for DevSkim security findings (recursive scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - issue_count
                  - severity_high_plus
      - name: value_count
        tests:
          - not_null

  - name: stg_lz_dotcover_assembly_coverage
    description: "Assembly-level code coverage from dotCover analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: assembly_name
        tests:
          - not_null
      - name: covered_statements
        tests:
          - not_null
      - name: total_statements
        tests:
          - not_null
      - name: statement_coverage_pct
        tests:
          - not_null

  - name: stg_lz_dotcover_type_coverage
    description: "Type (class) level code coverage from dotCover analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: assembly_name
        tests:
          - not_null
      - name: type_name
        tests:
          - not_null
      - name: covered_statements
        tests:
          - not_null
      - name: total_statements
        tests:
          - not_null
      - name: statement_coverage_pct
        tests:
          - not_null

  - name: stg_lz_dotcover_method_coverage
    description: "Method-level code coverage from dotCover analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: assembly_name
        tests:
          - not_null
      - name: type_name
        tests:
          - not_null
      - name: method_name
        tests:
          - not_null
      - name: covered_statements
        tests:
          - not_null
      - name: total_statements
        tests:
          - not_null
      - name: statement_coverage_pct
        tests:
          - not_null

  - name: stg_scancode_file_metrics
    description: "File-level aggregation of license findings from scancode analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: license_count
        tests:
          - not_null

  - name: stg_dotcover_file_metrics
    description: "File-level aggregation of type coverage from dotCover analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: type_count
        tests:
          - not_null
      - name: statement_coverage_pct
        tests:
          - not_null

  - name: rollup_scancode_directory_counts_direct
    description: "Scancode license counts per directory (direct scope - files in directory only)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_license_count
        tests:
          - not_null

  - name: rollup_scancode_directory_counts_recursive
    description: "Scancode license counts per directory (recursive scope - includes subtree)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_license_count
        tests:
          - not_null

  - name: rollup_scancode_directory_direct_distributions
    description: "Distribution statistics for scancode license metrics (direct scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - license_count
                  - avg_confidence
      - name: value_count
        tests:
          - not_null

  - name: rollup_scancode_directory_recursive_distributions
    description: "Distribution statistics for scancode license metrics (recursive scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - license_count
                  - avg_confidence
      - name: value_count
        tests:
          - not_null

  - name: rollup_dotcover_directory_counts_direct
    description: "Dotcover coverage counts per directory (direct scope - files in directory only)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_type_count
        tests:
          - not_null

  - name: rollup_dotcover_directory_counts_recursive
    description: "Dotcover coverage counts per directory (recursive scope - includes subtree)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: file_count
        tests:
          - not_null
      - name: total_type_count
        tests:
          - not_null

  - name: rollup_dotcover_directory_direct_distributions
    description: "Distribution statistics for dotcover coverage metrics (direct scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - statement_coverage_pct
                  - type_count
      - name: value_count
        tests:
          - not_null

  - name: rollup_dotcover_directory_recursive_distributions
    description: "Distribution statistics for dotcover coverage metrics (recursive scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - statement_coverage_pct
                  - type_count
      - name: value_count
        tests:
          - not_null

  - name: stg_symbol_coupling_metrics
    description: "Per-symbol coupling metrics: fan-in, fan-out, and instability"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: symbol_name
        tests:
          - not_null
      - name: fan_in
        tests:
          - not_null
      - name: fan_out
        tests:
          - not_null
      - name: total_coupling
        tests:
          - not_null
      - name: instability
        tests:
          - not_null

  - name: mart_blast_radius_symbol
    description: "Transitive caller analysis for change impact assessment"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: target_symbol
        tests:
          - not_null
      - name: blast_radius_symbols
        tests:
          - not_null
      - name: blast_radius_files
        tests:
          - not_null
      - name: max_depth
        tests:
          - not_null
      - name: blast_radius_risk
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - low
                  - medium
                  - high
                  - critical

  - name: mart_circular_dependencies
    description: "Circular dependency detection in import graph"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: start_file
        tests:
          - not_null
      - name: cycle_path
        tests:
          - not_null
      - name: cycle_length
        tests:
          - not_null
      - name: severity
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - low
                  - medium
                  - high
                  - critical

  - name: stg_lz_git_fame_authors
    description: "Per-author authorship metrics from git-fame analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: author_name
        tests:
          - not_null
      - name: surviving_loc
        tests:
          - not_null
      - name: ownership_pct
        tests:
          - not_null
      - name: commit_count
        tests:
          - not_null
      - name: files_touched
        tests:
          - not_null

  - name: stg_lz_git_fame_summary
    description: "Repository-level authorship summary from git-fame analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - unique
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: repo_id
        tests:
          - not_null
      - name: author_count
        tests:
          - not_null
      - name: total_loc
        tests:
          - not_null
      - name: hhi_index
        tests:
          - not_null
      - name: bus_factor
        tests:
          - not_null
      - name: top_author_pct
        tests:
          - not_null
      - name: top_two_pct
        tests:
          - not_null

  - name: mart_authorship_summary
    description: "Authorship summary combining git-fame metrics with unified code metrics for correlation analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - unique
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: collection_run_id
        tests:
          - not_null
          - relationships:
              to: source('lz', 'lz_collection_runs')
              field: collection_run_id
      - name: repo_id
        tests:
          - not_null
      - name: author_count
        tests:
          - not_null
      - name: hhi_index
        tests:
          - not_null
      - name: bus_factor
        tests:
          - not_null
      - name: concentration_risk
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - low
                  - medium
                  - high
      - name: bus_factor_risk
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - critical
                  - warning
                  - healthy
      - name: single_author_dominated
        tests:
          - not_null

  - name: mart_author_contributions
    description: "Author contributions ranked and tiered by contribution level with commitment metrics"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: author_name
        tests:
          - not_null
      - name: surviving_loc
        tests:
          - not_null
      - name: ownership_pct
        tests:
          - not_null
      - name: commit_count
        tests:
          - not_null
      - name: files_touched
        tests:
          - not_null
      - name: contribution_rank
        tests:
          - not_null
      - name: contribution_tier
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - top_10_pct
                  - top_25_pct
                  - top_50_pct
                  - bottom_50_pct

  - name: mart_authorship_risk
    description: "Authorship risk assessment with team health grades and recommended actions"
    columns:
      - name: run_pk
        tests:
          - not_null
          - unique
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: collection_run_id
        tests:
          - not_null
          - relationships:
              to: source('lz', 'lz_collection_runs')
              field: collection_run_id
      - name: repo_id
        tests:
          - not_null
      - name: author_count
        tests:
          - not_null
      - name: hhi_index
        tests:
          - not_null
      - name: bus_factor
        tests:
          - not_null
      - name: concentration_level
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - highly_concentrated
                  - moderately_concentrated
                  - slightly_concentrated
                  - well_distributed
      - name: bus_factor_assessment
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - no_data
                  - critical
                  - at_risk
                  - moderate
                  - healthy
      - name: single_author_risk
        tests:
          - not_null
      - name: top_two_dominance
        tests:
          - not_null
      - name: team_health_grade
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - A
                  - B
                  - C
                  - D
                  - F
      - name: recommended_action
        tests:
          - not_null

  - name: mart_project_dependency_cycles
    description: "Circular dependency detection in .NET project reference graph"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: start_project
        tests:
          - not_null
      - name: cycle_path
        tests:
          - not_null
      - name: cycle_length
        tests:
          - not_null
      - name: severity
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - low
                  - medium
                  - high
                  - critical

  - name: mart_project_blast_radius
    description: "Impact analysis for .NET project changes"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: target_project_path
        tests:
          - not_null
      - name: blast_radius_projects
        tests:
          - not_null
      - name: blast_radius_depth
        tests:
          - not_null
      - name: total_paths
        tests:
          - not_null
      - name: blast_radius_risk
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - low
                  - medium
                  - high
                  - critical

  - name: mart_package_version_conflicts
    description: "NuGet package version conflict detection"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: package_name
        tests:
          - not_null
      - name: version_count
        tests:
          - not_null
      - name: versions_list
        tests:
          - not_null
      - name: projects_affected
        tests:
          - not_null
      - name: conflict_severity
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - low
                  - medium
                  - high
                  - critical

  - name: mart_dependency_health_summary
    description: "Repository-level .NET dependency health metrics"
    columns:
      - name: run_pk
        tests:
          - not_null
          - unique
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: total_projects
        tests:
          - not_null
      - name: total_project_refs
        tests:
          - not_null
      - name: total_package_refs
        tests:
          - not_null
      - name: unique_packages
        tests:
          - not_null
      - name: circular_dependency_count
        tests:
          - not_null
      - name: version_conflict_count
        tests:
          - not_null
      - name: health_grade
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - A
                  - B
                  - C
                  - D
                  - F
      - name: recommendations
        tests:
          - not_null

  - name: stg_dependensee_projects
    description: "Staged .NET project information from dependensee analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: project_path
        tests:
          - not_null
      - name: project_name
        tests:
          - not_null

  - name: stg_dependensee_project_refs
    description: "Staged .NET project references from dependensee analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: source_project_path
        tests:
          - not_null
      - name: target_project_path
        tests:
          - not_null

  - name: stg_dependensee_package_refs
    description: "Staged NuGet package references from dependensee analysis"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: project_path
        tests:
          - not_null
      - name: package_name
        tests:
          - not_null

  - name: unified_repo_metrics
    description: "Unified repository-level metrics combining git-sizer health and git-fame authorship metrics"
    columns:
      - name: collection_run_id
        description: "Unique collection run identifier"
        tests:
          - not_null
          - relationships:
              arguments:
                to: source('lz', 'lz_collection_runs')
                field: collection_run_id
      - name: repo_id
        description: "Repository identifier"
        tests:
          - not_null
      - name: commit
        description: "Commit SHA"
        tests:
          - not_null
      - name: branch
        description: "Branch name"
      - name: git_sizer_run_pk
        description: "Git-sizer tool run primary key (null if not available)"
        tests:
          - relationships:
              arguments:
                to: ref('stg_lz_tool_runs')
                field: run_pk
      - name: health_grade
        description: "Repository health grade from git-sizer (A-F)"
        tests:
          - accepted_values:
              arguments:
                values: ['A', 'A+', 'B', 'B+', 'C', 'C+', 'D', 'D+', 'F']
      - name: commit_count
        description: "Total number of commits in the repository"
      - name: blob_total_size
        description: "Total size of all blobs in bytes"
      - name: max_blob_size
        description: "Size of the largest blob in bytes"
      - name: branch_count
        description: "Number of branches"
      - name: tag_count
        description: "Number of tags"
      - name: max_path_depth
        description: "Maximum directory nesting depth"
      - name: max_path_length
        description: "Longest file path length"
      - name: expanded_blob_size
        description: "Working directory size in bytes"
      - name: violation_count
        description: "Number of git-sizer threshold violations"
        tests:
          - not_null
      - name: max_violation_level
        description: "Highest violation severity level (1-4, 4 being most severe)"
        tests:
          - accepted_values:
              arguments:
                values: [1, 2, 3, 4]
      - name: lfs_candidate_count
        description: "Number of files recommended for Git LFS migration"
        tests:
          - not_null
      - name: git_fame_run_pk
        description: "Git-fame tool run primary key (null if not available)"
        tests:
          - relationships:
              arguments:
                to: ref('stg_lz_tool_runs')
                field: run_pk
      - name: author_count
        description: "Total number of contributors"
      - name: total_loc
        description: "Total lines of code"
      - name: hhi_index
        description: "Herfindahl-Hirschman Index for ownership concentration (0-10000)"
      - name: bus_factor
        description: "Minimum authors for 50% coverage (knowledge concentration risk)"
      - name: top_author_pct
        description: "Top contributor's percentage of code ownership"
      - name: top_two_pct
        description: "Top two contributors' combined percentage"
      - name: sources
        description: "Comma-separated list of tools with data for this repo"
        tests:
          - not_null

  - name: mart_complexity_hotspots
    description: "Function-level complexity hotspots identifying high-CCN functions as refactoring candidates using McCabe/NIST thresholds"
    columns:
      - name: run_pk
        description: "Lizard tool run primary key"
        tests:
          - not_null
          - relationships:
              to: ref('stg_lz_tool_runs')
              field: run_pk
      - name: collection_run_id
        description: "Collection run identifier"
        tests:
          - not_null
          - relationships:
              to: source('lz', 'lz_collection_runs')
              field: collection_run_id
      - name: file_id
        description: "File identifier from layout-scanner"
        tests:
          - not_null
      - name: relative_path
        description: "Repository-relative file path"
        tests:
          - not_null
      - name: directory_id
        description: "Directory identifier for file location"
        tests:
          - not_null
      - name: function_name
        description: "Short function name"
        tests:
          - not_null
      - name: long_name
        description: "Fully qualified function name with parameters"
        tests:
          - not_null
      - name: ccn
        description: "Cyclomatic Complexity Number (McCabe complexity)"
        tests:
          - not_null
      - name: nloc
        description: "Non-commenting Lines Of Code in function"
        tests:
          - not_null
      - name: params
        description: "Number of parameters"
        tests:
          - not_null
      - name: token_count
        description: "Number of tokens in function"
        tests:
          - not_null
      - name: line_start
        description: "Starting line number"
        tests:
          - not_null
      - name: line_end
        description: "Ending line number"
        tests:
          - not_null
      - name: line_span
        description: "Number of lines the function spans (line_end - line_start + 1)"
        tests:
          - not_null
      - name: complexity_density
        description: "CCN per line of code (ccn / nloc)"
      - name: risk_level
        description: "Risk classification: low (1-10), medium (11-20), high (21-50), critical (51+)"
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - low
                  - medium
                  - high
                  - critical
      - name: risk_level_numeric
        description: "Numeric risk level: 1=low, 2=medium, 3=high, 4=critical"
        tests:
          - not_null
          - accepted_values:
              arguments:
                values: [1, 2, 3, 4]
      - name: relative_position
        description: "Statistical position relative to run: normal, above_median, p90_outlier, p95_outlier, p99_outlier"
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - normal
                  - above_median
                  - p90_outlier
                  - p95_outlier
                  - p99_outlier
      - name: ccn_zscore
        description: "Z-score of CCN relative to run distribution (stddevs from mean)"
        tests:
          - not_null
      - name: is_medium_plus
        description: "True if CCN > 10 (medium risk or higher)"
        tests:
          - not_null
      - name: is_high_plus
        description: "True if CCN > 20 (high risk or higher)"
        tests:
          - not_null
      - name: is_critical
        description: "True if CCN > 50 (critical risk)"
        tests:
          - not_null
      - name: run_ccn_avg
        description: "Average CCN across all functions in the run"
        tests:
          - not_null
      - name: run_ccn_stddev
        description: "Standard deviation of CCN across all functions in the run"
        tests:
          - not_null
      - name: run_ccn_p50
        description: "50th percentile (median) of CCN in the run"
        tests:
          - not_null
      - name: run_ccn_p75
        description: "75th percentile of CCN in the run"
        tests:
          - not_null
      - name: run_ccn_p90
        description: "90th percentile of CCN in the run"
        tests:
          - not_null
      - name: run_ccn_p95
        description: "95th percentile of CCN in the run"
        tests:
          - not_null
      - name: run_ccn_p99
        description: "99th percentile of CCN in the run"
        tests:
          - not_null
      - name: run_total_functions
        description: "Total number of functions analyzed in the run"
        tests:
          - not_null

  - name: mart_sonarqube_rule_hotspots
    description: "SonarQube rule-level hotspots identifying most impactful rules for code quality prioritization"
    columns:
      - name: run_pk
        description: "SonarQube tool run primary key"
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_lz_tool_runs')
                field: run_pk
      - name: collection_run_id
        description: "Collection run identifier"
        tests:
          - not_null
          - relationships:
              arguments:
                to: source('lz', 'lz_collection_runs')
                field: collection_run_id
      - name: rule_id
        description: "SonarQube rule identifier (e.g., 'csharpsquid:S1481')"
        tests:
          - not_null
      - name: issue_type
        description: "Issue category: BUG, VULNERABILITY, CODE_SMELL, SECURITY_HOTSPOT"
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - BUG
                  - VULNERABILITY
                  - CODE_SMELL
                  - SECURITY_HOTSPOT
      - name: issue_count
        description: "Total number of occurrences of this rule"
        tests:
          - not_null
      - name: files_affected
        description: "Number of distinct files where this rule triggered"
        tests:
          - not_null
      - name: severity_blocker
        description: "Count of BLOCKER severity issues"
        tests:
          - not_null
      - name: severity_critical
        description: "Count of CRITICAL severity issues"
        tests:
          - not_null
      - name: severity_major
        description: "Count of MAJOR severity issues"
        tests:
          - not_null
      - name: severity_minor
        description: "Count of MINOR severity issues"
        tests:
          - not_null
      - name: severity_info
        description: "Count of INFO severity issues"
        tests:
          - not_null
      - name: severity_high_plus
        description: "Count of BLOCKER + CRITICAL severity issues"
        tests:
          - not_null
      - name: total_effort_minutes
        description: "Total estimated fix effort in minutes for this rule"
        tests:
          - not_null
      - name: avg_effort_minutes
        description: "Average fix effort per issue in minutes"
        tests:
          - not_null
      - name: open_count
        description: "Number of issues still in OPEN status"
        tests:
          - not_null
      - name: impact_score
        description: "Weighted impact score: blocker*4 + critical*3 + major*2 + minor*1"
        tests:
          - not_null
      - name: occurrence_rank
        description: "Rank by issue count within collection run (1 = most frequent)"
        tests:
          - not_null
      - name: effort_rank
        description: "Rank by total effort within collection run (1 = highest effort)"
        tests:
          - not_null
      - name: impact_rank
        description: "Rank by impact score within collection run (1 = highest impact)"
        tests:
          - not_null
      - name: risk_level
        description: "Risk classification based on severity: critical (blocker), high (critical), medium (major), low (minor/info)"
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - critical
                  - high
                  - medium
                  - low

  - name: mart_trivy_vulnerability_hotspots
    description: "Trivy vulnerability hotspots: CVE-level aggregation for remediation prioritization"
    columns:
      - name: run_pk
        description: "Trivy tool run primary key"
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_lz_tool_runs')
                field: run_pk
      - name: collection_run_id
        description: "Collection run identifier"
        tests:
          - not_null
          - relationships:
              arguments:
                to: source('lz', 'lz_collection_runs')
                field: collection_run_id
      - name: vulnerability_id
        description: "CVE or vulnerability identifier (e.g., 'CVE-2023-12345')"
        tests:
          - not_null
      - name: title
        description: "Representative title/description for this vulnerability"
      - name: occurrence_count
        description: "Total occurrences of this CVE across all packages"
        tests:
          - not_null
      - name: packages_affected
        description: "Number of distinct packages with this vulnerability"
        tests:
          - not_null
      - name: severity_critical
        description: "Count of CRITICAL severity occurrences"
        tests:
          - not_null
      - name: severity_high
        description: "Count of HIGH severity occurrences"
        tests:
          - not_null
      - name: severity_medium
        description: "Count of MEDIUM severity occurrences"
        tests:
          - not_null
      - name: severity_low
        description: "Count of LOW severity occurrences"
        tests:
          - not_null
      - name: severity_high_plus
        description: "Count of CRITICAL + HIGH severity occurrences"
        tests:
          - not_null
      - name: max_cvss_score
        description: "Maximum CVSS score across all occurrences"
      - name: avg_cvss_score
        description: "Average CVSS score across all occurrences"
      - name: fix_available_count
        description: "Number of occurrences with available fixes"
        tests:
          - not_null
      - name: fix_available_pct
        description: "Percentage of occurrences with available fixes"
        tests:
          - not_null
      - name: min_age_days
        description: "Minimum age in days since vulnerability was published"
      - name: max_age_days
        description: "Maximum age in days since vulnerability was published"
      - name: avg_age_days
        description: "Average age in days since vulnerability was published"
      - name: risk_score
        description: "Composite risk score: severity_weight  count  age_factor"
        tests:
          - not_null
      - name: occurrence_rank
        description: "Rank by occurrence count within collection run (1 = most frequent)"
        tests:
          - not_null
      - name: severity_rank
        description: "Rank by max CVSS score within collection run (1 = most severe)"
        tests:
          - not_null
      - name: risk_rank
        description: "Rank by composite risk score within collection run (1 = highest risk)"
        tests:
          - not_null
      - name: fixability_rank
        description: "Rank by fix availability within collection run (1 = most fixable)"
        tests:
          - not_null
      - name: risk_level
        description: "Risk classification based on max CVSS: critical (>=9), high (7-8.9), medium (4-6.9), low (<4)"
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - critical
                  - high
                  - medium
                  - low

  - name: mart_gitleaks_secret_hotspots
    description: "Gitleaks secret hotspots: rule-level aggregation for remediation prioritization"
    columns:
      - name: run_pk
        description: "Gitleaks tool run primary key"
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_lz_tool_runs')
                field: run_pk
      - name: rule_id
        description: "Gitleaks rule identifier (e.g., 'aws-access-key-id', 'generic-api-key')"
        tests:
          - not_null
      - name: secret_type
        description: "Type of secret detected (e.g., 'AWS', 'Generic API Key')"
      - name: description
        description: "Rule description"
      - name: detection_count
        description: "Total detections of this secret type"
        tests:
          - not_null
      - name: files_affected
        description: "Number of distinct files with this secret type"
        tests:
          - not_null
      - name: authors_affected
        description: "Number of distinct commit authors who introduced this secret type"
        tests:
          - not_null
      - name: in_head_count
        description: "Secrets still present in current HEAD (urgent - requires remediation)"
        tests:
          - not_null
      - name: historical_count
        description: "Secrets only in git history (less urgent - already removed)"
        tests:
          - not_null
      - name: in_head_pct
        description: "Percentage of detections still in current HEAD"
      - name: severity_critical
        description: "Count of CRITICAL severity detections"
        tests:
          - not_null
      - name: severity_high
        description: "Count of HIGH severity detections"
        tests:
          - not_null
      - name: severity_medium
        description: "Count of MEDIUM severity detections"
        tests:
          - not_null
      - name: severity_low
        description: "Count of LOW severity detections"
        tests:
          - not_null
      - name: severity_high_plus
        description: "Count of CRITICAL + HIGH severity detections"
        tests:
          - not_null
      - name: min_entropy
        description: "Minimum entropy value across detections"
      - name: max_entropy
        description: "Maximum entropy value across detections"
      - name: avg_entropy
        description: "Average entropy value across detections"
      - name: high_entropy_count
        description: "Detections with entropy > 4.0 (more likely real secrets)"
        tests:
          - not_null
      - name: risk_score
        description: "Composite risk score: in_head_count  severity_weight"
        tests:
          - not_null
      - name: detection_rank
        description: "Rank by detection count within run (1 = most frequent)"
        tests:
          - not_null
      - name: urgency_rank
        description: "Rank by in_head_count within run (1 = most urgent)"
        tests:
          - not_null
      - name: risk_rank
        description: "Rank by risk score within run (1 = highest risk)"
        tests:
          - not_null
      - name: risk_level
        description: "Risk classification: critical (in_head + CRITICAL), high (in_head + HIGH), medium (in_head), low (historical only)"
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - critical
                  - high
                  - medium
                  - low

  - name: mart_roslyn_rule_hotspots
    description: "Roslyn analyzer rule hotspots for code quality prioritization"
    columns:
      - name: run_pk
        description: "Tool run primary key"
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_lz_tool_runs')
                field: run_pk
      - name: rule_id
        description: "Roslyn analyzer rule identifier (e.g. CA1000)"
        tests:
          - not_null
      - name: dd_category
        description: "Design/documentation category for the rule"
      - name: sample_message
        description: "Example violation message for this rule"
      - name: violation_count
        description: "Total violations of this rule"
        tests:
          - not_null
      - name: files_affected
        description: "Count of distinct files with this violation"
        tests:
          - not_null
      - name: directories_affected
        description: "Count of distinct directories with this violation"
        tests:
          - not_null
      - name: severity_error
        description: "Count of Error severity violations"
        tests:
          - not_null
      - name: severity_warning
        description: "Count of Warning severity violations"
        tests:
          - not_null
      - name: severity_info
        description: "Count of Info severity violations"
        tests:
          - not_null
      - name: severity_hidden
        description: "Count of Hidden severity violations"
        tests:
          - not_null
      - name: severity_high_plus
        description: "Count of Error + Warning severity violations"
        tests:
          - not_null
      - name: severity_score
        description: "Weighted severity score: Error4 + Warning3 + Info2 + Hidden1"
        tests:
          - not_null
      - name: violation_rank
        description: "Rank by violation count within run (1 = most frequent)"
        tests:
          - not_null
      - name: severity_rank
        description: "Rank by error count, then warning count within run (1 = most severe)"
        tests:
          - not_null
      - name: spread_rank
        description: "Rank by files affected within run (1 = most widespread)"
        tests:
          - not_null
      - name: risk_level
        description: "Risk classification: critical (has Error), high (has Warning), medium (has Info), low (Hidden only)"
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - critical
                  - high
                  - medium
                  - low

  - name: rollup_git_sizer_lfs_candidates_direct
    description: "Git-sizer LFS candidates per directory (direct scope - files in directory only)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_lz_tool_runs')
                field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: lfs_candidate_count
        tests:
          - not_null

  - name: rollup_git_sizer_lfs_candidates_recursive
    description: "Git-sizer LFS candidates per directory (recursive scope - all files in subtree)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_lz_tool_runs')
                field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: directory_path
        tests:
          - not_null
      - name: lfs_candidate_count
        tests:
          - not_null

  - name: stg_coupling_file_metrics
    description: "File-level aggregation of symbol coupling metrics"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_lz_tool_runs')
                field: run_pk
      - name: file_id
        tests:
          - not_null
      - name: directory_id
        tests:
          - not_null
      - name: relative_path
        tests:
          - not_null
      - name: symbol_count
        tests:
          - not_null
      - name: total_fan_out
        tests:
          - not_null
      - name: total_fan_in
        tests:
          - not_null

  - name: rollup_coupling_directory_direct_distributions
    description: "Distribution statistics for coupling metrics (direct scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_lz_tool_runs')
                field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - total_fan_out
                  - total_fan_in
                  - total_coupling
                  - avg_instability
      - name: value_count
        tests:
          - not_null

  - name: rollup_coupling_directory_recursive_distributions
    description: "Distribution statistics for coupling metrics (recursive scope)"
    columns:
      - name: run_pk
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_lz_tool_runs')
                field: run_pk
      - name: directory_id
        tests:
          - not_null
      - name: metric
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - total_fan_out
                  - total_fan_in
                  - total_coupling
                  - avg_instability
      - name: value_count
        tests:
          - not_null

  - name: mart_pmd_cpd_clone_hotspots
    description: "PMD-CPD clone hotspots for code duplication prioritization"
    columns:
      - name: run_pk
        description: "Tool run primary key"
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_lz_tool_runs')
                field: run_pk
      - name: clone_id
        description: "Unique identifier for the clone group"
        tests:
          - not_null
      - name: lines
        description: "Number of lines in the cloned code"
        tests:
          - not_null
      - name: tokens
        description: "Number of tokens in the cloned code"
        tests:
          - not_null
      - name: occurrence_count
        description: "Number of times this code appears (>=2)"
        tests:
          - not_null
      - name: is_cross_file
        description: "Whether the clone spans multiple files"
        tests:
          - not_null
      - name: files_affected
        description: "Count of distinct files containing this clone"
        tests:
          - not_null
      - name: directories_affected
        description: "Count of distinct directories containing this clone"
        tests:
          - not_null
      - name: total_duplicated_lines
        description: "Total code debt: lines  occurrence_count"
        tests:
          - not_null
      - name: token_density
        description: "Complexity indicator: tokens / lines"
      - name: impact_score
        description: "Impact metric: size  occurrences  spread factor (1.5 for cross-file)"
        tests:
          - not_null
      - name: size_rank
        description: "Rank by lines within run (1 = largest clone)"
        tests:
          - not_null
      - name: occurrence_rank
        description: "Rank by occurrence count within run (1 = most repeated)"
        tests:
          - not_null
      - name: impact_rank
        description: "Rank by total duplicated lines within run (1 = highest debt)"
        tests:
          - not_null
      - name: spread_rank
        description: "Rank by files affected within run (1 = most widespread)"
        tests:
          - not_null
      - name: risk_level
        description: "Risk classification: critical (>=100 lines + cross-file), high (>=100 lines or >=50 + cross-file or >=5 occurrences), medium (>=20 lines or cross-file or >=3 occurrences), low (small same-file clones)"
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - critical
                  - high
                  - medium
                  - low

  - name: mart_semgrep_rule_hotspots
    description: "Semgrep rule hotspots for code quality prioritization"
    columns:
      - name: run_pk
        description: "Tool run primary key"
        tests:
          - not_null
          - relationships:
              arguments:
                to: ref('stg_lz_tool_runs')
                field: run_pk
      - name: rule_id
        description: "Semgrep rule identifier"
        tests:
          - not_null
      - name: dd_category
        description: "Category classification for the rule"
      - name: sample_message
        description: "Example message for this rule"
      - name: smell_count
        description: "Total occurrences of this rule"
        tests:
          - not_null
      - name: files_affected
        description: "Count of distinct files with this smell"
        tests:
          - not_null
      - name: directories_affected
        description: "Count of distinct directories with this smell"
        tests:
          - not_null
      - name: severity_critical
        description: "Count of CRITICAL severity smells"
        tests:
          - not_null
      - name: severity_high
        description: "Count of HIGH severity smells"
        tests:
          - not_null
      - name: severity_medium
        description: "Count of MEDIUM severity smells"
        tests:
          - not_null
      - name: severity_low
        description: "Count of LOW severity smells"
        tests:
          - not_null
      - name: severity_info
        description: "Count of INFO severity smells"
        tests:
          - not_null
      - name: severity_high_plus
        description: "Count of CRITICAL + HIGH severity smells"
        tests:
          - not_null
      - name: severity_score
        description: "Weighted score: CRITICAL*5 + HIGH*4 + MEDIUM*3 + LOW*2 + INFO*1"
        tests:
          - not_null
      - name: smell_rank
        description: "Rank by smell_count within run (1 = most frequent)"
        tests:
          - not_null
      - name: severity_rank
        description: "Rank by critical/high counts within run (1 = most severe)"
        tests:
          - not_null
      - name: spread_rank
        description: "Rank by files_affected within run (1 = most widespread)"
        tests:
          - not_null
      - name: risk_level
        description: "Risk classification: critical (has CRITICAL), high (has HIGH), medium (has MEDIUM), low (LOW or INFO only)"
        tests:
          - not_null
          - accepted_values:
              arguments:
                values:
                  - critical
                  - high
                  - medium
                  - low