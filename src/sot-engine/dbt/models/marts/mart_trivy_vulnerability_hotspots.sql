-- Trivy vulnerability hotspots: identify most impactful CVEs for remediation prioritization
-- Risk levels: critical (CVSS >= 9), high (7-8.9), medium (4-6.9), low (<4)

with vuln_metrics as (
    select
        run_pk,
        collection_run_id,
        vulnerability_id,
        -- Representative title (first one)
        max(title) as title,
        count(*) as occurrence_count,
        count(distinct package_name) as packages_affected,
        -- Severity breakdown
        count(*) filter (where severity = 'CRITICAL') as severity_critical,
        count(*) filter (where severity = 'HIGH') as severity_high,
        count(*) filter (where severity = 'MEDIUM') as severity_medium,
        count(*) filter (where severity = 'LOW') as severity_low,
        count(*) filter (where severity in ('CRITICAL', 'HIGH')) as severity_high_plus,
        -- CVSS metrics
        max(cvss_score) as max_cvss_score,
        round(avg(cvss_score), 1) as avg_cvss_score,
        -- Fixability metrics
        count(*) filter (where fix_available = true) as fix_available_count,
        round(100.0 * count(*) filter (where fix_available = true) / count(*), 1) as fix_available_pct,
        -- Age metrics (older = riskier exposure)
        min(age_days) as min_age_days,
        max(age_days) as max_age_days,
        round(avg(age_days), 0) as avg_age_days,
        -- Risk score: severity weight × count × age factor
        (case max(severity)
            when 'CRITICAL' then 4
            when 'HIGH' then 3
            when 'MEDIUM' then 2
            else 1
        end * count(*) * (1 + ln(1 + coalesce(avg(age_days), 0) / 30.0))) as risk_score
    from {{ ref('stg_trivy_vulnerabilities') }}
    group by run_pk, collection_run_id, vulnerability_id
),
ranked_vulns as (
    select
        *,
        row_number() over (partition by collection_run_id order by occurrence_count desc) as occurrence_rank,
        row_number() over (partition by collection_run_id order by max_cvss_score desc nulls last) as severity_rank,
        row_number() over (partition by collection_run_id order by risk_score desc) as risk_rank,
        row_number() over (partition by collection_run_id order by fix_available_pct desc, occurrence_count desc) as fixability_rank,
        -- Risk level based on max CVSS
        case
            when max_cvss_score >= 9.0 then 'critical'
            when max_cvss_score >= 7.0 then 'high'
            when max_cvss_score >= 4.0 then 'medium'
            else 'low'
        end as risk_level
    from vuln_metrics
)
select
    run_pk,
    collection_run_id,
    vulnerability_id,
    title,
    occurrence_count,
    packages_affected,
    severity_critical,
    severity_high,
    severity_medium,
    severity_low,
    severity_high_plus,
    max_cvss_score,
    avg_cvss_score,
    fix_available_count,
    fix_available_pct,
    min_age_days,
    max_age_days,
    avg_age_days,
    risk_score,
    occurrence_rank,
    severity_rank,
    risk_rank,
    fixability_rank,
    risk_level
from ranked_vulns
order by collection_run_id, risk_score desc
