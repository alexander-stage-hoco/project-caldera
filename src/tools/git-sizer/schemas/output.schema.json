{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://caldera.internal/schemas/git-sizer/output.schema.json",
  "title": "git-sizer Output Schema",
  "description": "Caldera envelope format for git-sizer repository health analysis output",
  "type": "object",
  "required": ["metadata", "data"],
  "properties": {
    "metadata": {
      "type": "object",
      "description": "Caldera standard metadata envelope",
      "required": [
        "tool_name",
        "tool_version",
        "run_id",
        "repo_id",
        "branch",
        "commit",
        "timestamp",
        "schema_version"
      ],
      "properties": {
        "tool_name": {
          "type": "string",
          "const": "git-sizer",
          "description": "Tool identifier"
        },
        "tool_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+",
          "description": "Version of git-sizer used"
        },
        "run_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for the collection run"
        },
        "repo_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for the repository"
        },
        "branch": {
          "type": "string",
          "minLength": 1,
          "description": "Git branch analyzed"
        },
        "commit": {
          "type": "string",
          "pattern": "^[0-9a-f]{40}$",
          "description": "40-character commit SHA"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of when the analysis was generated"
        },
        "schema_version": {
          "type": "string",
          "const": "1.0.0",
          "description": "Schema version (fixed for this schema)"
        }
      },
      "additionalProperties": false
    },
    "data": {
      "type": "object",
      "description": "git-sizer analysis results",
      "required": ["tool", "tool_version", "health_grade", "metrics"],
      "properties": {
        "tool": {
          "type": "string",
          "const": "git-sizer",
          "description": "Tool identifier"
        },
        "tool_version": {
          "type": "string",
          "description": "Version of git-sizer used"
        },
        "health_grade": {
          "type": "string",
          "pattern": "^[A-F][+]?$",
          "description": "Overall repository health grade (A-F, optionally with +)"
        },
        "duration_ms": {
          "type": "integer",
          "minimum": 0,
          "description": "Analysis duration in milliseconds"
        },
        "metrics": {
          "$ref": "#/$defs/Metrics"
        },
        "violations": {
          "type": "array",
          "items": {
            "$ref": "#/$defs/Violation"
          },
          "description": "Threshold violations detected"
        },
        "lfs_candidates": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "Files that should be migrated to Git LFS (repo-relative paths)"
        },
        "raw_output": {
          "type": "object",
          "additionalProperties": true,
          "description": "Original git-sizer JSON output (preserved for debugging)"
        }
      },
      "additionalProperties": false
    }
  },
  "additionalProperties": false,
  "$defs": {
    "Metrics": {
      "type": "object",
      "description": "Repository size and structure metrics",
      "properties": {
        "commit_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of unique commits"
        },
        "commit_total_size": {
          "type": "integer",
          "minimum": 0,
          "description": "Total size of all commits in bytes"
        },
        "max_commit_size": {
          "type": "integer",
          "minimum": 0,
          "description": "Size of largest commit in bytes"
        },
        "max_history_depth": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum depth of commit history"
        },
        "max_parent_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum number of parents on any commit (merge complexity)"
        },
        "tree_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of unique trees"
        },
        "tree_total_size": {
          "type": "integer",
          "minimum": 0,
          "description": "Total size of all trees in bytes"
        },
        "tree_total_entries": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of entries across all trees"
        },
        "max_tree_entries": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum entries in a single tree (directory width)"
        },
        "blob_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of unique blobs"
        },
        "blob_total_size": {
          "type": "integer",
          "minimum": 0,
          "description": "Total size of all blobs in bytes"
        },
        "max_blob_size": {
          "type": "integer",
          "minimum": 0,
          "description": "Size of largest blob in bytes"
        },
        "tag_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of unique tags"
        },
        "max_tag_depth": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum tag chain depth"
        },
        "reference_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of references"
        },
        "branch_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of branches"
        },
        "max_path_depth": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum directory depth"
        },
        "max_path_length": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum path length in characters"
        },
        "expanded_tree_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of trees in expanded checkout"
        },
        "expanded_blob_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of blobs in expanded checkout"
        },
        "expanded_blob_size": {
          "type": "integer",
          "minimum": 0,
          "description": "Total size of blobs in expanded checkout"
        }
      },
      "additionalProperties": false
    },
    "Violation": {
      "type": "object",
      "description": "Threshold violation detected by git-sizer",
      "required": ["metric", "level"],
      "properties": {
        "metric": {
          "type": "string",
          "description": "Name of the violated metric"
        },
        "value": {
          "type": "string",
          "description": "Human-readable value (e.g., '10.5 MiB')"
        },
        "raw_value": {
          "type": "integer",
          "description": "Raw numeric value"
        },
        "level": {
          "type": "integer",
          "minimum": 1,
          "maximum": 4,
          "description": "Severity level (1-4, higher is worse: * ** *** !!!!)"
        },
        "object_ref": {
          "type": "string",
          "description": "Git object reference if applicable"
        }
      },
      "additionalProperties": false
    }
  }
}
