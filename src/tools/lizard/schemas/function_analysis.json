{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://dd-analyzer.local/schemas/function-analysis/2.0",
  "title": "Function Analysis Output",
  "description": "Schema for Lizard function-level complexity analysis output (v2.0, aligned with TOOL_REQUIREMENTS.md)",
  "type": "object",
  "required": ["schema_version", "generated_at", "repo_name", "repo_path", "results"],
  "properties": {
    "schema_version": {
      "type": "string",
      "pattern": "^\\d+\\.\\d+\\.\\d+$",
      "description": "Schema version (semver, e.g., '2.0.0')"
    },
    "generated_at": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 timestamp of analysis"
    },
    "repo_name": {
      "type": "string",
      "description": "Repository identifier"
    },
    "repo_path": {
      "type": "string",
      "description": "Path to analyzed repository"
    },
    "results": {
      "type": "object",
      "description": "Tool-specific analysis results",
      "required": ["run_id", "timestamp", "files", "summary"],
      "properties": {
        "run_id": {
          "type": "string",
          "pattern": "^fn-[0-9]{8}-[0-9]{6}$",
          "description": "Unique run identifier (format: fn-YYYYMMDD-HHMMSS)"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of analysis"
        },
        "root_path": {
          "type": "string",
          "description": "Root path that was analyzed"
        },
        "lizard_version": {
          "type": "string",
          "description": "Version of lizard used for analysis"
        },
        "directories": {
          "type": "array",
          "description": "Directory-level aggregated statistics",
          "items": { "$ref": "#/definitions/directory" }
        },
        "files": {
          "type": "array",
          "description": "Per-file analysis results",
          "items": { "$ref": "#/definitions/file" }
        },
        "summary": {
          "$ref": "#/definitions/summary"
        },
        "by_language": {
          "type": "object",
          "description": "Summary stats per language",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "file_count": { "type": "integer", "minimum": 0 },
              "function_count": { "type": "integer", "minimum": 0 },
              "total_nloc": { "type": "integer", "minimum": 0 },
              "total_ccn": { "type": "integer", "minimum": 0 },
              "avg_ccn": { "type": "number", "minimum": 0 },
              "max_ccn": { "type": "integer", "minimum": 0 }
            }
          }
        }
      }
    }
  },
  "definitions": {
    "function": {
      "type": "object",
      "description": "Function-level metrics",
      "required": ["name", "ccn", "nloc", "start_line", "end_line"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Function name (may include class prefix)"
        },
        "long_name": {
          "type": "string",
          "description": "Fully qualified function name"
        },
        "ccn": {
          "type": "integer",
          "minimum": 1,
          "description": "Cyclomatic complexity (McCabe)"
        },
        "nloc": {
          "type": "integer",
          "minimum": 0,
          "description": "Non-commenting lines of code"
        },
        "token_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of tokens in function"
        },
        "parameter_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of function parameters"
        },
        "start_line": {
          "type": "integer",
          "minimum": 1,
          "description": "Starting line number (1-indexed)"
        },
        "end_line": {
          "type": "integer",
          "minimum": 1,
          "description": "Ending line number (1-indexed)"
        },
        "length": {
          "type": "integer",
          "minimum": 0,
          "description": "Function length in lines"
        },
        "max_nesting": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum nesting depth"
        }
      }
    },
    "file": {
      "type": "object",
      "description": "Per-file analysis result",
      "required": ["path", "language", "functions"],
      "properties": {
        "path": {
          "type": "string",
          "description": "File path relative to root"
        },
        "language": {
          "type": "string",
          "description": "Detected programming language"
        },
        "nloc": {
          "type": "integer",
          "minimum": 0,
          "description": "Total NLOC in file"
        },
        "functions": {
          "type": "array",
          "items": { "$ref": "#/definitions/function" }
        },
        "function_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of functions in file"
        },
        "total_ccn": {
          "type": "integer",
          "minimum": 0,
          "description": "Sum of CCN for all functions"
        },
        "avg_ccn": {
          "type": "number",
          "minimum": 0,
          "description": "Average CCN per function"
        },
        "max_ccn": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum CCN in file"
        }
      }
    },
    "distribution": {
      "type": "object",
      "description": "Statistical distribution metrics (22 metrics)",
      "properties": {
        "count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of values in distribution"
        },
        "min": { "type": "number", "description": "Minimum value" },
        "max": { "type": "number", "description": "Maximum value" },
        "mean": { "type": "number", "description": "Arithmetic mean" },
        "median": { "type": "number", "description": "Median (P50)" },
        "stddev": { "type": "number", "minimum": 0, "description": "Standard deviation" },
        "p25": { "type": "number", "description": "25th percentile" },
        "p50": { "type": "number", "description": "50th percentile (median)" },
        "p75": { "type": "number", "description": "75th percentile" },
        "p90": { "type": "number", "description": "90th percentile" },
        "p95": { "type": "number", "description": "95th percentile" },
        "p99": { "type": "number", "description": "99th percentile" },
        "skewness": {
          "type": "number",
          "description": "Distribution skewness (>0 = right-skewed)"
        },
        "kurtosis": {
          "type": "number",
          "description": "Excess kurtosis (>0 = heavy-tailed)"
        },
        "cv": {
          "type": "number",
          "minimum": 0,
          "description": "Coefficient of variation (stddev/mean)"
        },
        "iqr": {
          "type": "number",
          "minimum": 0,
          "description": "Interquartile range (P75-P25)"
        },
        "gini": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Gini coefficient (0=equal, 1=concentrated)"
        },
        "theil": {
          "type": "number",
          "minimum": 0,
          "description": "Theil index (entropy-based inequality)"
        },
        "hoover": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Hoover index (Robin Hood index)"
        },
        "palma": {
          "type": "number",
          "minimum": 0,
          "description": "Palma ratio (top 10% / bottom 40%)"
        },
        "top_10_pct_share": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Share held by top 10%"
        },
        "top_20_pct_share": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Share held by top 20%"
        },
        "bottom_50_pct_share": {
          "type": "number",
          "minimum": 0,
          "maximum": 1,
          "description": "Share held by bottom 50%"
        }
      }
    },
    "directory_stats": {
      "type": "object",
      "description": "Statistics for a directory (direct or recursive)",
      "properties": {
        "file_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of files with functions"
        },
        "function_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Total number of functions"
        },
        "nloc": {
          "type": "integer",
          "minimum": 0,
          "description": "Total NLOC across functions"
        },
        "ccn": {
          "type": "integer",
          "minimum": 0,
          "description": "Total CCN across functions"
        },
        "avg_ccn": {
          "type": "number",
          "minimum": 0,
          "description": "Average CCN per function"
        },
        "max_ccn": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum CCN in directory"
        },
        "avg_nloc": {
          "type": "number",
          "minimum": 0,
          "description": "Average NLOC per function"
        },
        "max_nloc": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum NLOC in directory"
        },
        "avg_params": {
          "type": "number",
          "minimum": 0,
          "description": "Average parameter count"
        },
        "max_params": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum parameter count"
        },
        "functions_over_threshold": {
          "type": "integer",
          "minimum": 0,
          "description": "Functions with CCN > threshold"
        },
        "ccn_distribution": { "$ref": "#/definitions/distribution" },
        "nloc_distribution": { "$ref": "#/definitions/distribution" },
        "params_distribution": { "$ref": "#/definitions/distribution" }
      }
    },
    "directory": {
      "type": "object",
      "description": "Directory-level aggregated statistics",
      "required": ["path", "name", "depth"],
      "properties": {
        "path": {
          "type": "string",
          "description": "Directory path relative to root"
        },
        "name": {
          "type": "string",
          "description": "Directory name"
        },
        "depth": {
          "type": "integer",
          "minimum": 0,
          "description": "Depth from root (0 = root)"
        },
        "is_leaf": {
          "type": "boolean",
          "description": "True if no subdirectories with functions"
        },
        "child_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Number of direct child directories"
        },
        "direct": {
          "$ref": "#/definitions/directory_stats",
          "description": "Stats for files directly in this directory"
        },
        "recursive": {
          "$ref": "#/definitions/directory_stats",
          "description": "Stats including all subdirectories"
        },
        "subdirectories": {
          "type": "array",
          "items": { "type": "string" },
          "description": "Paths to child directories"
        }
      }
    },
    "summary": {
      "type": "object",
      "description": "Analysis summary statistics",
      "required": ["total_files", "total_functions"],
      "properties": {
        "total_files": {
          "type": "integer",
          "minimum": 0,
          "description": "Total files analyzed"
        },
        "total_functions": {
          "type": "integer",
          "minimum": 0,
          "description": "Total functions detected"
        },
        "total_nloc": {
          "type": "integer",
          "minimum": 0,
          "description": "Total NLOC across all functions"
        },
        "total_ccn": {
          "type": "integer",
          "minimum": 0,
          "description": "Sum of all CCN values"
        },
        "avg_ccn": {
          "type": "number",
          "minimum": 0,
          "description": "Average CCN per function"
        },
        "max_ccn": {
          "type": "integer",
          "minimum": 0,
          "description": "Maximum CCN found"
        },
        "functions_over_threshold": {
          "type": "integer",
          "minimum": 0,
          "description": "Functions exceeding CCN threshold"
        },
        "ccn_distribution": { "$ref": "#/definitions/distribution" },
        "nloc_distribution": { "$ref": "#/definitions/distribution" },
        "params_distribution": { "$ref": "#/definitions/distribution" },
        "by_language": {
          "type": "object",
          "description": "Summary stats per language",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "file_count": { "type": "integer", "minimum": 0 },
              "function_count": { "type": "integer", "minimum": 0 },
              "total_nloc": { "type": "integer", "minimum": 0 },
              "total_ccn": { "type": "integer", "minimum": 0 },
              "avg_ccn": { "type": "number", "minimum": 0 },
              "max_ccn": { "type": "integer", "minimum": 0 }
            }
          }
        },
        "structure": {
          "type": "object",
          "description": "Directory structure statistics",
          "properties": {
            "total_directories": { "type": "integer", "minimum": 0 },
            "max_depth": { "type": "integer", "minimum": 0 },
            "avg_depth": { "type": "number", "minimum": 0 },
            "leaf_directory_count": { "type": "integer", "minimum": 0 },
            "avg_functions_per_directory": { "type": "number", "minimum": 0 }
          }
        }
      }
    }
  }
}
