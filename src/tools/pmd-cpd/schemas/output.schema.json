{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "pmd-cpd-output.v1.0.0",
  "title": "PMD CPD Analysis Output",
  "description": "Schema for PMD Copy/Paste Detector analysis output in Caldera envelope format",
  "type": "object",
  "required": ["metadata", "data"],
  "properties": {
    "metadata": {
      "type": "object",
      "description": "Standard Caldera metadata envelope",
      "required": ["tool_name", "tool_version", "run_id", "repo_id", "branch", "commit", "timestamp", "schema_version"],
      "properties": {
        "tool_name": {
          "type": "string",
          "const": "pmd-cpd",
          "description": "Tool identifier"
        },
        "tool_version": {
          "type": "string",
          "description": "Version of pmd-cpd used for analysis"
        },
        "run_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for this analysis run"
        },
        "repo_id": {
          "type": "string",
          "format": "uuid",
          "description": "Unique identifier for the repository"
        },
        "branch": {
          "type": "string",
          "description": "Git branch name"
        },
        "commit": {
          "type": "string",
          "pattern": "^[0-9a-f]{40}$",
          "description": "Git commit SHA (40 hex characters)"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "ISO 8601 timestamp of when the analysis was run"
        },
        "schema_version": {
          "type": "string",
          "const": "1.0.0",
          "description": "Schema version"
        }
      }
    },
    "data": {
      "type": "object",
      "description": "Tool-specific analysis results",
      "required": ["tool", "config", "summary", "files", "duplications"],
      "properties": {
        "tool": {
          "type": "string",
          "const": "pmd-cpd",
          "description": "Tool identifier"
        },
        "config": {
          "type": "object",
          "description": "Analysis configuration",
          "properties": {
            "min_tokens": {
              "type": "integer",
              "description": "Minimum token threshold for duplication detection"
            },
            "ignore_identifiers": {
              "type": "boolean",
              "description": "Whether identifier names are ignored (semantic mode)"
            },
            "ignore_literals": {
              "type": "boolean",
              "description": "Whether literal values are ignored (semantic mode)"
            }
          }
        },
        "elapsed_seconds": {
          "type": "number",
          "description": "Analysis duration in seconds"
        },
        "summary": {
          "type": "object",
          "description": "High-level summary statistics",
          "required": ["total_files", "total_clones", "duplication_percentage"],
          "properties": {
            "total_files": {
              "type": "integer",
              "description": "Total number of source files analyzed"
            },
            "total_clones": {
              "type": "integer",
              "description": "Total number of code clones detected"
            },
            "duplication_percentage": {
              "type": "number",
              "minimum": 0,
              "maximum": 100,
              "description": "Overall duplication percentage across the codebase"
            },
            "cross_file_clones": {
              "type": "integer",
              "description": "Number of clones spanning multiple files"
            }
          }
        },
        "files": {
          "type": "array",
          "description": "Per-file duplication metrics",
          "items": {
            "type": "object",
            "required": ["path", "total_lines", "duplicate_lines", "duplicate_blocks", "duplication_percentage"],
            "properties": {
              "path": {
                "type": "string",
                "description": "Relative path to file within repository"
              },
              "total_lines": {
                "type": "integer",
                "description": "Total lines in the file"
              },
              "duplicate_lines": {
                "type": "integer",
                "description": "Number of duplicated lines"
              },
              "duplicate_blocks": {
                "type": "integer",
                "description": "Number of duplicate code blocks"
              },
              "duplication_percentage": {
                "type": "number",
                "minimum": 0,
                "maximum": 100,
                "description": "Percentage of file that is duplicated"
              },
              "language": {
                "type": "string",
                "description": "Detected programming language"
              }
            }
          }
        },
        "duplications": {
          "type": "array",
          "description": "Detailed duplication findings",
          "items": {
            "type": "object",
            "required": ["clone_id", "lines", "tokens", "occurrences"],
            "properties": {
              "clone_id": {
                "type": "string",
                "pattern": "^CPD-\\d{4}$",
                "description": "Unique identifier for the clone"
              },
              "lines": {
                "type": "integer",
                "description": "Number of lines in the duplicated block"
              },
              "tokens": {
                "type": "integer",
                "description": "Number of tokens in the duplicated block"
              },
              "occurrences": {
                "type": "array",
                "minItems": 2,
                "description": "Locations where this clone appears",
                "items": {
                  "type": "object",
                  "required": ["file", "line_start", "line_end"],
                  "properties": {
                    "file": {
                      "type": "string",
                      "description": "Relative file path"
                    },
                    "line_start": {
                      "type": "integer",
                      "minimum": 1,
                      "description": "Starting line number"
                    },
                    "line_end": {
                      "type": "integer",
                      "minimum": 1,
                      "description": "Ending line number"
                    },
                    "column_start": {
                      "type": "integer",
                      "minimum": 0,
                      "description": "Starting column"
                    },
                    "column_end": {
                      "type": "integer",
                      "minimum": 0,
                      "description": "Ending column"
                    }
                  }
                }
              },
              "code_fragment": {
                "type": "string",
                "maxLength": 500,
                "description": "Sample of the duplicated code (truncated)"
              }
            }
          }
        },
        "statistics": {
          "type": "object",
          "description": "Aggregate statistics by language and type",
          "properties": {
            "cross_file_clones": {
              "type": "integer",
              "description": "Number of clones spanning multiple files"
            },
            "total_tokens": {
              "type": "integer",
              "description": "Total duplicate tokens across all clones"
            },
            "total_duplicate_lines": {
              "type": "integer",
              "description": "Total duplicate lines across all clones"
            },
            "by_language": {
              "type": "object",
              "description": "Statistics grouped by programming language",
              "additionalProperties": {
                "type": "object",
                "properties": {
                  "clone_count": {
                    "type": "integer"
                  },
                  "total_lines": {
                    "type": "integer"
                  }
                }
              }
            }
          }
        },
        "errors": {
          "type": "array",
          "description": "Any errors or warnings during analysis",
          "items": {
            "type": "string"
          }
        }
      }
    }
  }
}
