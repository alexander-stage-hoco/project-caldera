"""Unit tests for vulnerability_analyzer module."""

import json
import tempfile
from datetime import datetime, timezone
from pathlib import Path
from unittest.mock import MagicMock, patch

import pytest

from vulnerability_analyzer import (
    DirectoryMetrics,
    MisconfigurationFinding,
    PackageFreshness,
    SBOMSummary,
    TargetSummary,
    VulnerabilityAnalysis,
    VulnerabilityFinding,
    analysis_to_dict,
    calculate_age_days,
    compute_directory_rollups,
    get_trivy_version,
    parse_trivy_output,
)


class TestVulnerabilityFinding:
    """Tests for VulnerabilityFinding dataclass."""

    def test_create_vulnerability_finding(self):
        """Test creating a VulnerabilityFinding instance."""
        finding = VulnerabilityFinding(
            id="CVE-2021-33503",
            severity="HIGH",
            package="urllib3",
            installed_version="1.26.0",
            fixed_version="1.26.5",
            title="ReDoS vulnerability",
            description="Test description",
            cvss_score=7.5,
            cvss_vector="CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
            published_date="2021-06-29T11:15:07Z",
            age_days=1660,
            fix_available=True,
            target="requirements.txt",
            target_type="pip",
        )

        assert finding.id == "CVE-2021-33503"
        assert finding.severity == "HIGH"
        assert finding.package == "urllib3"
        assert finding.fix_available is True
        assert finding.cvss_score == 7.5

    def test_critical_vulnerability(self):
        """Test creating a critical severity finding."""
        finding = VulnerabilityFinding(
            id="CVE-2020-14343",
            severity="CRITICAL",
            package="pyyaml",
            installed_version="5.3",
            fixed_version="5.4",
            title="Arbitrary code execution",
            description="Critical vulnerability",
            cvss_score=9.8,
            cvss_vector="",
            published_date="2021-02-09T21:15:12Z",
            age_days=1800,
            fix_available=True,
            target="requirements.txt",
            target_type="pip",
        )

        assert finding.severity == "CRITICAL"
        assert finding.cvss_score == 9.8


class TestMisconfigurationFinding:
    """Tests for MisconfigurationFinding dataclass."""

    def test_create_misconfig_finding(self):
        """Test creating a MisconfigurationFinding instance."""
        finding = MisconfigurationFinding(
            id="DS002",
            severity="HIGH",
            title="Root user",
            description="Container runs as root",
            resolution="Add USER instruction",
            target="Dockerfile",
            target_type="dockerfile",
            start_line=1,
            end_line=5,
        )

        assert finding.id == "DS002"
        assert finding.severity == "HIGH"
        assert finding.target == "Dockerfile"
        assert finding.start_line == 1


class TestTargetSummary:
    """Tests for TargetSummary dataclass."""

    def test_create_target_summary(self):
        """Test creating a TargetSummary instance."""
        summary = TargetSummary(
            path="requirements.txt",
            type="pip",
            vulnerability_count=14,
            critical_count=2,
            high_count=5,
            medium_count=7,
            low_count=0,
            dependency_count=3,
        )

        assert summary.path == "requirements.txt"
        assert summary.type == "pip"
        assert summary.vulnerability_count == 14
        assert summary.critical_count == 2


class TestDirectoryMetrics:
    """Tests for DirectoryMetrics dataclass."""

    def test_create_directory_metrics(self):
        """Test creating DirectoryMetrics instance."""
        metrics = DirectoryMetrics(
            vulnerability_count=10,
            critical_count=2,
            high_count=3,
            medium_count=4,
            low_count=1,
            target_count=2,
        )

        assert metrics.vulnerability_count == 10
        assert metrics.critical_count == 2
        assert metrics.target_count == 2


class TestSBOMSummary:
    """Tests for SBOMSummary dataclass."""

    def test_sbom_defaults(self):
        """Test SBOMSummary default values."""
        sbom = SBOMSummary()

        assert sbom.format == "trivy-json"
        assert sbom.total_packages == 0
        assert sbom.vulnerable_packages == 0
        assert sbom.clean_packages == 0

    def test_sbom_with_values(self):
        """Test SBOMSummary with custom values."""
        sbom = SBOMSummary(
            format="cyclonedx",
            total_packages=100,
            vulnerable_packages=10,
            clean_packages=90,
        )

        assert sbom.format == "cyclonedx"
        assert sbom.total_packages == 100


class TestVulnerabilityAnalysis:
    """Tests for VulnerabilityAnalysis dataclass."""

    def test_default_values(self):
        """Test VulnerabilityAnalysis default values."""
        analysis = VulnerabilityAnalysis()

        assert analysis.schema_version == "1.0.0"
        assert analysis.tool == "trivy"
        assert analysis.total_vulnerabilities == 0
        assert analysis.critical_count == 0
        assert analysis.freshness_checked is False
        assert analysis.vulnerabilities == []
        assert analysis.misconfigurations == []

    def test_with_vulnerability_counts(self):
        """Test VulnerabilityAnalysis with counts."""
        analysis = VulnerabilityAnalysis(
            repo_name="test-repo",
            total_vulnerabilities=14,
            critical_count=2,
            high_count=5,
            medium_count=7,
            low_count=0,
        )

        assert analysis.repo_name == "test-repo"
        assert analysis.total_vulnerabilities == 14
        assert analysis.critical_count == 2

    def test_with_freshness_data(self):
        """Test VulnerabilityAnalysis with freshness data."""
        pkg = PackageFreshness(
            package="requests",
            package_type="pip",
            installed_version="2.25.0",
            latest_version="2.31.0",
            major_versions_behind=0,
            minor_versions_behind=6,
            patch_versions_behind=0,
            is_outdated=True,
            days_since_latest=100,
            has_vulnerability=True,
            vulnerability_count=2,
        )

        analysis = VulnerabilityAnalysis(
            freshness_checked=True,
            outdated_count=1,
            package_freshness=[pkg],
        )

        assert analysis.freshness_checked is True
        assert analysis.outdated_count == 1
        assert len(analysis.package_freshness) == 1


class TestCalculateAgeDays:
    """Tests for calculate_age_days function."""

    def test_valid_iso_date_with_z(self):
        """Test parsing ISO date with Z suffix."""
        result = calculate_age_days("2020-01-01T00:00:00Z")
        assert result > 1000  # Should be > 5 years old

    def test_valid_iso_date_with_offset(self):
        """Test parsing ISO date with timezone offset."""
        result = calculate_age_days("2020-01-01T00:00:00+00:00")
        assert result > 1000

    def test_simple_date_format(self):
        """Test parsing simple date format."""
        result = calculate_age_days("2020-01-01")
        assert result > 1000

    def test_empty_date(self):
        """Test handling of empty date."""
        result = calculate_age_days("")
        assert result == 0

    def test_none_date(self):
        """Test handling of None date (via empty string path)."""
        result = calculate_age_days("")
        assert result == 0

    def test_invalid_date_format(self):
        """Test handling of invalid date format."""
        result = calculate_age_days("not-a-date")
        assert result == 0

    def test_recent_date(self):
        """Test a recent date."""
        # Yesterday
        from datetime import timedelta

        yesterday = (datetime.now(timezone.utc) - timedelta(days=1)).strftime(
            "%Y-%m-%dT%H:%M:%SZ"
        )
        result = calculate_age_days(yesterday)
        assert result >= 0 and result <= 2


class TestParseTrivyOutput:
    """Tests for parse_trivy_output function."""

    def test_parse_vulnerabilities(self, sample_trivy_raw_output):
        """Test parsing vulnerabilities from raw output."""
        vulns, misconfigs, targets, pkg_count = parse_trivy_output(
            sample_trivy_raw_output
        )

        assert len(vulns) == 2  # CVE-2021-33503 and CVE-2020-14343
        assert vulns[0].id == "CVE-2021-33503"
        assert vulns[0].severity == "HIGH"
        assert vulns[0].package == "urllib3"

    def test_parse_misconfigurations(self, sample_trivy_raw_output):
        """Test parsing misconfigurations from raw output."""
        vulns, misconfigs, targets, pkg_count = parse_trivy_output(
            sample_trivy_raw_output
        )

        assert len(misconfigs) == 1
        assert misconfigs[0].id == "DS002"
        assert misconfigs[0].severity == "HIGH"

    def test_parse_targets(self, sample_trivy_raw_output):
        """Test parsing targets from raw output."""
        vulns, misconfigs, targets, pkg_count = parse_trivy_output(
            sample_trivy_raw_output
        )

        # Should have targets from both vuln and misconfig results
        assert len(targets) >= 1

    def test_parse_package_count(self, sample_trivy_raw_output):
        """Test parsing package count from raw output."""
        vulns, misconfigs, targets, pkg_count = parse_trivy_output(
            sample_trivy_raw_output
        )

        assert pkg_count == 3  # requests, urllib3, pyyaml

    def test_parse_empty_results(self):
        """Test parsing empty results."""
        vulns, misconfigs, targets, pkg_count = parse_trivy_output({"Results": []})

        assert vulns == []
        assert misconfigs == []
        assert targets == []
        assert pkg_count == 0

    def test_parse_no_results_key(self):
        """Test parsing output without Results key."""
        vulns, misconfigs, targets, pkg_count = parse_trivy_output({})

        assert vulns == []
        assert misconfigs == []
        assert targets == []
        assert pkg_count == 0

    def test_cvss_score_extraction(self, sample_trivy_raw_output):
        """Test CVSS score extraction from vulnerability."""
        vulns, _, _, _ = parse_trivy_output(sample_trivy_raw_output)

        # First vuln should have CVSS score
        high_vuln = next(v for v in vulns if v.severity == "HIGH")
        assert high_vuln.cvss_score == 7.5

        critical_vuln = next(v for v in vulns if v.severity == "CRITICAL")
        assert critical_vuln.cvss_score == 9.8


class TestComputeDirectoryRollups:
    """Tests for compute_directory_rollups function."""

    def test_compute_rollups_single_target(self):
        """Test computing rollups for single target."""
        vulns = [
            VulnerabilityFinding(
                id="CVE-1",
                severity="CRITICAL",
                package="pkg1",
                installed_version="1.0.0",
                fixed_version="1.0.1",
                title="Test",
                description="Test",
                cvss_score=9.0,
                cvss_vector="",
                published_date="",
                age_days=100,
                fix_available=True,
                target="requirements.txt",
                target_type="pip",
            ),
            VulnerabilityFinding(
                id="CVE-2",
                severity="HIGH",
                package="pkg2",
                installed_version="1.0.0",
                fixed_version="1.0.1",
                title="Test",
                description="Test",
                cvss_score=7.0,
                cvss_vector="",
                published_date="",
                age_days=50,
                fix_available=True,
                target="requirements.txt",
                target_type="pip",
            ),
        ]

        result = compute_directory_rollups(vulns)

        assert "directory_count" in result
        assert "directories" in result
        assert result["directory_count"] >= 1

    def test_compute_rollups_multiple_targets(self):
        """Test computing rollups for multiple targets in different dirs."""
        vulns = [
            VulnerabilityFinding(
                id="CVE-1",
                severity="CRITICAL",
                package="pkg1",
                installed_version="1.0.0",
                fixed_version="1.0.1",
                title="Test",
                description="Test",
                cvss_score=9.0,
                cvss_vector="",
                published_date="",
                age_days=100,
                fix_available=True,
                target="frontend/package.json",
                target_type="npm",
            ),
            VulnerabilityFinding(
                id="CVE-2",
                severity="HIGH",
                package="pkg2",
                installed_version="1.0.0",
                fixed_version="1.0.1",
                title="Test",
                description="Test",
                cvss_score=7.0,
                cvss_vector="",
                published_date="",
                age_days=50,
                fix_available=True,
                target="backend/requirements.txt",
                target_type="pip",
            ),
        ]

        result = compute_directory_rollups(vulns)

        assert result["directory_count"] >= 2
        # Should have rollups for frontend, backend, and root

    def test_compute_rollups_empty(self):
        """Test computing rollups with no vulnerabilities."""
        result = compute_directory_rollups([])

        assert result["directory_count"] == 0
        assert result["directories"] == []


class TestAnalysisToDict:
    """Tests for analysis_to_dict function."""

    def test_basic_conversion(self):
        """Test basic analysis to dict conversion."""
        analysis = VulnerabilityAnalysis(
            repo_name="test-repo",
            repo_path="/path/to/repo",
            generated_at="2026-01-15T10:00:00Z",
            tool_version="0.58.0",
            total_vulnerabilities=5,
            critical_count=1,
            high_count=2,
            medium_count=2,
            low_count=0,
        )

        result = analysis_to_dict(analysis)

        assert result["schema_version"] == "1.0.0"
        assert result["repo_name"] == "test-repo"
        assert result["generated_at"] == "2026-01-15T10:00:00Z"
        assert "results" in result
        assert result["results"]["tool"] == "trivy"
        assert result["results"]["summary"]["total_vulnerabilities"] == 5

    def test_conversion_with_vulnerabilities(self):
        """Test conversion with vulnerability list."""
        vuln = VulnerabilityFinding(
            id="CVE-2021-33503",
            severity="HIGH",
            package="urllib3",
            installed_version="1.26.0",
            fixed_version="1.26.5",
            title="ReDoS",
            description="Test",
            cvss_score=7.5,
            cvss_vector="",
            published_date="",
            age_days=100,
            fix_available=True,
            target="requirements.txt",
            target_type="pip",
        )

        analysis = VulnerabilityAnalysis(
            repo_name="test-repo",
            vulnerabilities=[vuln],
        )

        result = analysis_to_dict(analysis)

        assert len(result["results"]["vulnerabilities"]) == 1
        assert result["results"]["vulnerabilities"][0]["id"] == "CVE-2021-33503"

    def test_conversion_with_freshness(self):
        """Test conversion with freshness data."""
        pkg = PackageFreshness(
            package="requests",
            package_type="pip",
            installed_version="2.25.0",
            latest_version="2.31.0",
            major_versions_behind=0,
            minor_versions_behind=6,
            patch_versions_behind=0,
            is_outdated=True,
            days_since_latest=100,
            has_vulnerability=False,
            vulnerability_count=0,
        )

        analysis = VulnerabilityAnalysis(
            repo_name="test-repo",
            freshness_checked=True,
            outdated_count=1,
            outdated_pct=100.0,
            package_freshness=[pkg],
        )

        result = analysis_to_dict(analysis)

        assert "freshness" in result["results"]
        assert result["results"]["freshness"]["checked"] is True
        assert result["results"]["freshness"]["total_packages"] == 1
        assert len(result["results"]["freshness"]["packages"]) == 1

    def test_conversion_without_freshness(self):
        """Test conversion without freshness data."""
        analysis = VulnerabilityAnalysis(
            repo_name="test-repo",
            freshness_checked=False,
        )

        result = analysis_to_dict(analysis)

        assert "freshness" not in result["results"]

    def test_conversion_with_misconfigurations(self):
        """Test conversion with IaC misconfigurations."""
        misconfig = MisconfigurationFinding(
            id="DS002",
            severity="HIGH",
            title="Root user",
            description="Container runs as root",
            resolution="Add USER instruction",
            target="Dockerfile",
            target_type="dockerfile",
            start_line=1,
            end_line=5,
        )

        analysis = VulnerabilityAnalysis(
            repo_name="test-repo",
            iac_total_count=1,
            iac_critical_count=0,
            iac_high_count=1,
            misconfigurations=[misconfig],
        )

        result = analysis_to_dict(analysis)

        assert result["results"]["iac_misconfigurations"]["total_count"] == 1
        assert len(result["results"]["iac_misconfigurations"]["misconfigurations"]) == 1


class TestGetTrivyVersion:
    """Tests for get_trivy_version function."""

    def test_get_version_success(self):
        """Test getting trivy version successfully."""
        mock_result = MagicMock()
        mock_result.returncode = 0
        mock_result.stdout = '{"Version": "0.58.0"}'

        with patch("subprocess.run", return_value=mock_result):
            version = get_trivy_version(Path("/fake/trivy"))

        assert version == "0.58.0"

    def test_get_version_failure(self):
        """Test getting trivy version when command fails."""
        mock_result = MagicMock()
        mock_result.returncode = 1
        mock_result.stdout = ""

        with patch("subprocess.run", return_value=mock_result):
            version = get_trivy_version(Path("/fake/trivy"))

        assert version == "unknown"

    def test_get_version_invalid_json(self):
        """Test getting trivy version with invalid JSON output."""
        mock_result = MagicMock()
        mock_result.returncode = 0
        mock_result.stdout = "not json"

        with patch("subprocess.run", return_value=mock_result):
            version = get_trivy_version(Path("/fake/trivy"))

        assert version == "unknown"
