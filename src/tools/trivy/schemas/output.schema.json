{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "trivy.output.v1.0.0",
  "title": "Trivy Output Schema",
  "description": "Unified output schema for Trivy vulnerability scanner",
  "type": "object",
  "required": ["metadata", "data"],
  "properties": {
    "metadata": {
      "type": "object",
      "required": [
        "tool_name",
        "tool_version",
        "run_id",
        "repo_id",
        "branch",
        "commit",
        "timestamp",
        "schema_version"
      ],
      "properties": {
        "tool_name": {
          "type": "string",
          "const": "trivy"
        },
        "tool_version": {
          "type": "string",
          "pattern": "^\\d+\\.\\d+\\.\\d+"
        },
        "run_id": {
          "type": "string",
          "minLength": 1
        },
        "repo_id": {
          "type": "string",
          "minLength": 1
        },
        "branch": {
          "type": "string"
        },
        "commit": {
          "type": "string",
          "pattern": "^[0-9a-fA-F]{40}$"
        },
        "timestamp": {
          "type": "string",
          "format": "date-time"
        },
        "schema_version": {
          "type": "string",
          "const": "1.0.0"
        }
      }
    },
    "data": {
      "type": "object",
      "required": ["tool", "tool_version", "targets", "vulnerabilities"],
      "properties": {
        "tool": {
          "type": "string",
          "const": "trivy"
        },
        "tool_version": {
          "type": "string"
        },
        "scan_type": {
          "type": "string",
          "enum": ["fs", "image", "repo"]
        },
        "targets": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["path", "type"],
            "properties": {
              "path": {
                "type": "string",
                "description": "Relative path to target file (lockfile, manifest, etc.)"
              },
              "type": {
                "type": "string",
                "description": "Target type (npm, pip, maven, terraform, etc.)"
              },
              "vulnerability_count": {
                "type": "integer",
                "minimum": 0
              },
              "critical_count": {
                "type": "integer",
                "minimum": 0
              },
              "high_count": {
                "type": "integer",
                "minimum": 0
              },
              "medium_count": {
                "type": "integer",
                "minimum": 0
              },
              "low_count": {
                "type": "integer",
                "minimum": 0
              }
            }
          }
        },
        "vulnerabilities": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["id", "package", "severity"],
            "properties": {
              "id": {
                "type": "string",
                "description": "Vulnerability identifier (e.g., CVE-2021-23337)"
              },
              "target": {
                "type": "string",
                "description": "Target path where vulnerability was found"
              },
              "target_type": {
                "type": "string",
                "description": "Type of target (npm, pip, etc.)"
              },
              "package": {
                "type": "string",
                "description": "Package name"
              },
              "installed_version": {
                "type": ["string", "null"],
                "description": "Currently installed version"
              },
              "fixed_version": {
                "type": ["string", "null"],
                "description": "Version with fix (if available)"
              },
              "severity": {
                "type": "string",
                "enum": ["CRITICAL", "HIGH", "MEDIUM", "LOW", "UNKNOWN"]
              },
              "cvss_score": {
                "type": ["number", "null"],
                "minimum": 0,
                "maximum": 10
              },
              "title": {
                "type": ["string", "null"],
                "description": "Vulnerability title/summary"
              },
              "description": {
                "type": ["string", "null"],
                "description": "Detailed description"
              },
              "published_date": {
                "type": ["string", "null"],
                "description": "Date vulnerability was published"
              },
              "age_days": {
                "type": ["integer", "null"],
                "description": "Days since vulnerability was published"
              },
              "fix_available": {
                "type": ["boolean", "null"],
                "description": "Whether a fix is available"
              },
              "references": {
                "type": "array",
                "items": {
                  "type": "string"
                }
              }
            }
          }
        },
        "iac_misconfigurations": {
          "type": "object",
          "properties": {
            "count": {
              "type": "integer",
              "minimum": 0
            },
            "misconfigurations": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["id", "severity"],
                "properties": {
                  "id": {
                    "type": "string"
                  },
                  "target": {
                    "type": "string"
                  },
                  "target_type": {
                    "type": "string"
                  },
                  "severity": {
                    "type": "string",
                    "enum": ["CRITICAL", "HIGH", "MEDIUM", "LOW", "UNKNOWN"]
                  },
                  "title": {
                    "type": ["string", "null"]
                  },
                  "description": {
                    "type": ["string", "null"]
                  },
                  "resolution": {
                    "type": ["string", "null"]
                  },
                  "start_line": {
                    "type": ["integer", "null"]
                  },
                  "end_line": {
                    "type": ["integer", "null"]
                  }
                }
              }
            }
          }
        },
        "findings_summary": {
          "type": "object",
          "properties": {
            "total_vulnerabilities": {
              "type": "integer",
              "minimum": 0
            },
            "total_misconfigurations": {
              "type": "integer",
              "minimum": 0
            },
            "by_severity": {
              "type": "object",
              "properties": {
                "CRITICAL": { "type": "integer", "minimum": 0 },
                "HIGH": { "type": "integer", "minimum": 0 },
                "MEDIUM": { "type": "integer", "minimum": 0 },
                "LOW": { "type": "integer", "minimum": 0 },
                "UNKNOWN": { "type": "integer", "minimum": 0 }
              }
            },
            "fixable_count": {
              "type": "integer",
              "minimum": 0
            }
          }
        },
        "ecosystem_completeness": {
          "type": "object",
          "description": "Pre-scan analysis of dependency files and ecosystem completeness",
          "properties": {
            "dependency_files": {
              "type": "array",
              "description": "List of discovered dependency files",
              "items": {
                "type": "object",
                "required": ["path", "ecosystem", "type"],
                "properties": {
                  "path": {
                    "type": "string",
                    "description": "Repo-relative path to dependency file"
                  },
                  "ecosystem": {
                    "type": "string",
                    "description": "Package ecosystem (npm, pip, go, rust, etc.)"
                  },
                  "type": {
                    "type": "string",
                    "enum": ["manifest", "lockfile"],
                    "description": "Whether this is a manifest or lockfile"
                  }
                }
              }
            },
            "ecosystems": {
              "type": "object",
              "description": "Status of each detected ecosystem",
              "additionalProperties": {
                "type": "object",
                "properties": {
                  "manifests": {
                    "type": "array",
                    "items": { "type": "string" },
                    "description": "List of manifest file paths"
                  },
                  "lockfiles": {
                    "type": "array",
                    "items": { "type": "string" },
                    "description": "List of lockfile paths"
                  },
                  "is_complete": {
                    "type": "boolean",
                    "description": "Whether the ecosystem has all expected files"
                  }
                }
              }
            },
            "warnings": {
              "type": "array",
              "description": "Warnings about incomplete ecosystems",
              "items": { "type": "string" }
            }
          }
        }
      }
    }
  }
}
