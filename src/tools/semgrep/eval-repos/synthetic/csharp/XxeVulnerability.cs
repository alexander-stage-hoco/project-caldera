/**
 * Test file for XML External Entity (XXE) vulnerability detection.
 * Contains XXE patterns for C#.
 */

using System;
using System.IO;
using System.Xml;
using System.Xml.Linq;
using System.Xml.Serialization;
using System.Xml.XPath;

namespace SmellTests.Security
{
    public class XxeVulnerabilityExamples
    {
        // XXE_VULNERABILITY: XmlDocument with DTD processing enabled
        public XmlDocument ParseXmlUnsafe(string xmlContent)
        {
            // BAD: DTD processing enabled (default before .NET 4.5.2)
            var doc = new XmlDocument();
            doc.XmlResolver = new XmlUrlResolver();  // BAD: Allows external entities
            doc.LoadXml(xmlContent);
            return doc;
        }

        // XXE_VULNERABILITY: XmlReader with unsafe settings
        public string ReadXmlUnsafe(string xmlPath)
        {
            // BAD: DtdProcessing.Parse enables DTD
            var settings = new XmlReaderSettings
            {
                DtdProcessing = DtdProcessing.Parse,  // BAD
                XmlResolver = new XmlUrlResolver()    // BAD
            };

            using var reader = XmlReader.Create(xmlPath, settings);
            while (reader.Read())
            {
                if (reader.NodeType == XmlNodeType.Text)
                {
                    return reader.Value;
                }
            }
            return string.Empty;
        }

        // XXE_VULNERABILITY: XmlTextReader without disabling DTD
        public XmlDocument ParseWithTextReader(string xml)
        {
            // BAD: XmlTextReader processes DTD by default
            using var textReader = new XmlTextReader(new StringReader(xml));
            // ProhibitDtd is false by default in older .NET
            var doc = new XmlDocument();
            doc.Load(textReader);
            return doc;
        }

        // XXE_VULNERABILITY: XDocument with resolver
        public XDocument LoadXDocumentUnsafe(string xmlPath)
        {
            // BAD: LoadOptions.SetBaseUri can resolve external entities
            var settings = new XmlReaderSettings
            {
                DtdProcessing = DtdProcessing.Parse,
                XmlResolver = new XmlUrlResolver()
            };

            using var reader = XmlReader.Create(xmlPath, settings);
            return XDocument.Load(reader);
        }

        // XXE_VULNERABILITY: XPathDocument with unsafe settings
        public XPathNavigator CreateNavigatorUnsafe(string xmlContent)
        {
            var settings = new XmlReaderSettings
            {
                DtdProcessing = DtdProcessing.Parse,  // BAD
                XmlResolver = new XmlUrlResolver()    // BAD
            };

            using var reader = XmlReader.Create(new StringReader(xmlContent), settings);
            var doc = new XPathDocument(reader);
            return doc.CreateNavigator();
        }

        // XXE_VULNERABILITY: XmlSerializer with unsafe reader
        public T DeserializeXmlUnsafe<T>(string xmlContent)
        {
            var settings = new XmlReaderSettings
            {
                DtdProcessing = DtdProcessing.Parse,  // BAD
                XmlResolver = new XmlUrlResolver()    // BAD
            };

            using var reader = XmlReader.Create(new StringReader(xmlContent), settings);
            var serializer = new XmlSerializer(typeof(T));
            return (T)serializer.Deserialize(reader);
        }

        // XXE_VULNERABILITY: Using XmlUrlResolver directly
        public object ResolveExternalEntity(string uri)
        {
            // BAD: XmlUrlResolver resolves external URIs
            var resolver = new XmlUrlResolver();
            resolver.Credentials = System.Net.CredentialCache.DefaultCredentials;
            return resolver.GetEntity(new Uri(uri), null, typeof(Stream));
        }

        // CORRECT: XmlDocument with XXE protection
        public XmlDocument ParseXmlSafe(string xmlContent)
        {
            // GOOD: XmlResolver set to null
            var doc = new XmlDocument();
            doc.XmlResolver = null;  // Prevents external entity resolution
            doc.LoadXml(xmlContent);
            return doc;
        }

        // CORRECT: XmlReader with safe settings
        public string ReadXmlSafe(string xmlPath)
        {
            // GOOD: DTD processing prohibited
            var settings = new XmlReaderSettings
            {
                DtdProcessing = DtdProcessing.Prohibit,
                XmlResolver = null
            };

            using var reader = XmlReader.Create(xmlPath, settings);
            while (reader.Read())
            {
                if (reader.NodeType == XmlNodeType.Text)
                {
                    return reader.Value;
                }
            }
            return string.Empty;
        }

        // CORRECT: XmlTextReader with DTD disabled
        public XmlDocument ParseWithTextReaderSafe(string xml)
        {
            // GOOD: Disable DTD processing
            using var textReader = new XmlTextReader(new StringReader(xml));
            textReader.DtdProcessing = DtdProcessing.Prohibit;

            var doc = new XmlDocument();
            doc.XmlResolver = null;
            doc.Load(textReader);
            return doc;
        }

        // CORRECT: Safe XmlSerializer usage
        public T DeserializeXmlSafe<T>(string xmlContent)
        {
            // GOOD: Safe settings
            var settings = new XmlReaderSettings
            {
                DtdProcessing = DtdProcessing.Prohibit,
                XmlResolver = null,
                MaxCharactersFromEntities = 1024  // Additional protection
            };

            using var reader = XmlReader.Create(new StringReader(xmlContent), settings);
            var serializer = new XmlSerializer(typeof(T));
            return (T)serializer.Deserialize(reader);
        }
    }
}
