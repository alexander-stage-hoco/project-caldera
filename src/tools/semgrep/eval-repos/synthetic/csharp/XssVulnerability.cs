/**
 * Test file for Cross-Site Scripting (XSS) vulnerability detection.
 * Contains multiple XSS patterns for C#/ASP.NET.
 */

using System;
using System.Web;
using System.Web.Mvc;
using Microsoft.AspNetCore.Html;
using Microsoft.AspNetCore.Mvc;

namespace SmellTests.Security
{
    public class XssController : Controller
    {
        // XSS_VULNERABILITY: Directly outputting user input to HTML
        public IActionResult UnsafeGreeting(string name)
        {
            // BAD: Direct concatenation without encoding
            ViewBag.Message = "<h1>Hello, " + name + "!</h1>";
            return View();
        }

        // XSS_VULNERABILITY: Html.Raw with user input
        public IActionResult UnsafeHtml(string content)
        {
            // BAD: Html.Raw bypasses encoding
            ViewBag.Content = new HtmlString(content);
            return View();
        }

        // XSS_VULNERABILITY: String interpolation in HTML response
        public IActionResult SearchResults(string query)
        {
            // BAD: User input in HTML string
            string html = $"<div class='results'>Search results for: {query}</div>";
            return Content(html, "text/html");
        }

        // XSS_VULNERABILITY: Response.Write with user input
        public void WriteResponse(string userInput)
        {
            // BAD: Direct Response.Write
            HttpContext.Response.WriteAsync("<script>alert('" + userInput + "')</script>");
        }

        // XSS_VULNERABILITY: Building JavaScript with user input
        public IActionResult DynamicScript(string callback)
        {
            // BAD: User input in JavaScript
            string script = $"<script>var data = {callback}('response');</script>";
            return Content(script, "text/html");
        }

        // XSS_VULNERABILITY: Setting innerHTML equivalent
        public IActionResult UnsafeAttribute(string title)
        {
            // BAD: User input in HTML attribute
            ViewBag.Title = $"<meta property=\"og:title\" content=\"{title}\">";
            return View();
        }

        // XSS_VULNERABILITY: URL parameter in href
        public IActionResult UnsafeLink(string url)
        {
            // BAD: User input in href (could be javascript:)
            string html = $"<a href=\"{url}\">Click here</a>";
            return Content(html, "text/html");
        }

        // XSS_VULNERABILITY: JSON response without proper encoding
        public IActionResult JsonCallback(string data, string callback)
        {
            // BAD: JSONP with user-controlled callback
            string response = $"{callback}({data})";
            return Content(response, "application/javascript");
        }

        // CORRECT: Using HTML encoding
        public IActionResult SafeGreeting(string name)
        {
            // GOOD: HTML encoding the user input
            ViewBag.Message = $"<h1>Hello, {HttpUtility.HtmlEncode(name)}!</h1>";
            return View();
        }

        // CORRECT: Using built-in encoding
        public IActionResult SafeSearch(string query)
        {
            // GOOD: Let Razor handle encoding
            ViewBag.SearchQuery = query; // Razor will encode this
            return View();
        }

        // CORRECT: Validated URL
        public IActionResult SafeLink(string url)
        {
            // GOOD: Validate URL scheme
            if (Uri.TryCreate(url, UriKind.Absolute, out var uri) &&
                (uri.Scheme == "http" || uri.Scheme == "https"))
            {
                ViewBag.SafeUrl = url;
            }
            return View();
        }
    }
}
