/**
 * Test file for Cross-Site Scripting (XSS) vulnerability detection.
 * Contains multiple XSS patterns for TypeScript/Node.js/Express.
 */

import { Request, Response } from 'express';

// XSS_VULNERABILITY: Directly outputting user input to HTML
function unsafeGreeting(req: Request, res: Response): void {
    const name = req.query.name as string;
    res.send(`<h1>Hello, ${name}!</h1>`);
}

// XSS_VULNERABILITY: Building HTML with user input
function unsafeSearchResults(req: Request, res: Response): void {
    const query = req.query.q as string;
    const html = "<div class='results'>Search results for: " + query + "</div>";
    res.send(html);
}

// XSS_VULNERABILITY: innerHTML pattern in template
function unsafeProfile(req: Request, res: Response): void {
    const bio = req.body.bio as string;
    const html = `<div class="profile"><div class="bio">${bio}</div></div>`;
    res.send(html);
}

// XSS_VULNERABILITY: Building JavaScript with user input
function unsafeCallback(req: Request, res: Response): void {
    const callback = req.query.callback as string;
    res.send(`<script>var data = ${callback}('response');</script>`);
}

// GOOD: Using HTML encoding
function safeGreeting(req: Request, res: Response): void {
    const name = req.query.name as string;
    const escaped = escapeHtml(name);
    res.send(`<h1>Hello, ${escaped}!</h1>`);
}

// GOOD: Using JSON serialization for script data
function safeScript(req: Request, res: Response): void {
    const data = req.body;
    res.send(`<script>var data = ${JSON.stringify(data)};</script>`);
}

// GOOD: Using Content-Type with no HTML
function safeJson(req: Request, res: Response): void {
    const data = req.body;
    res.json(data);
}

// Helper function for HTML escaping
function escapeHtml(unsafe: string): string {
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

export {
    unsafeGreeting,
    unsafeSearchResults,
    unsafeProfile,
    unsafeCallback,
    safeGreeting,
    safeScript,
    safeJson,
};
