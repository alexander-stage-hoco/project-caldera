{
  "$defs": {
    "directoryEntry": {
      "description": "Directory entry with direct and recursive statistics",
      "properties": {
        "child_count": {
          "description": "Number of direct child directories",
          "minimum": 0,
          "type": "integer"
        },
        "depth": {
          "description": "Depth in directory tree",
          "minimum": 0,
          "type": "integer"
        },
        "direct": {
          "$ref": "#/$defs/directoryStats"
        },
        "is_leaf": {
          "description": "Whether this is a leaf directory",
          "type": "boolean"
        },
        "name": {
          "description": "Directory name",
          "type": "string"
        },
        "path": {
          "description": "Directory path relative to repository root",
          "type": "string"
        },
        "recursive": {
          "$ref": "#/$defs/directoryStats"
        },
        "subdirectories": {
          "description": "List of direct child directory paths",
          "items": {
            "type": "string"
          },
          "type": "array"
        }
      },
      "required": [
        "path",
        "direct",
        "recursive"
      ],
      "type": "object"
    },
    "directoryStats": {
      "description": "Smell statistics for a directory (direct or recursive)",
      "properties": {
        "by_category": {
          "additionalProperties": {
            "minimum": 0,
            "type": "integer"
          },
          "type": "object"
        },
        "by_severity": {
          "additionalProperties": {
            "minimum": 0,
            "type": "integer"
          },
          "type": "object"
        },
        "by_smell_type": {
          "additionalProperties": {
            "minimum": 0,
            "type": "integer"
          },
          "type": "object"
        },
        "file_count": {
          "minimum": 0,
          "type": "integer"
        },
        "lines_code": {
          "minimum": 0,
          "type": "integer"
        },
        "smell_count": {
          "minimum": 0,
          "type": "integer"
        },
        "smell_density": {
          "description": "Smells per 100 lines of code",
          "minimum": 0,
          "type": "number"
        }
      },
      "type": "object"
    },
    "fileEntry": {
      "description": "File-level smell details",
      "properties": {
        "by_category": {
          "additionalProperties": {
            "minimum": 0,
            "type": "integer"
          },
          "type": "object"
        },
        "by_severity": {
          "additionalProperties": {
            "minimum": 0,
            "type": "integer"
          },
          "type": "object"
        },
        "by_smell_type": {
          "additionalProperties": {
            "minimum": 0,
            "type": "integer"
          },
          "type": "object"
        },
        "language": {
          "description": "Detected programming language",
          "type": "string"
        },
        "lines": {
          "description": "Total lines in file",
          "minimum": 0,
          "type": "integer"
        },
        "path": {
          "description": "File path relative to repository root",
          "type": "string"
        },
        "smell_count": {
          "description": "Number of smells in file",
          "minimum": 0,
          "type": "integer"
        },
        "smell_density": {
          "description": "Smells per 100 lines of code",
          "minimum": 0,
          "type": "number"
        },
        "smells": {
          "items": {
            "$ref": "#/$defs/smellEntry"
          },
          "type": "array"
        }
      },
      "required": [
        "path",
        "language"
      ],
      "type": "object"
    },
    "languageStats": {
      "description": "Statistics for a programming language",
      "properties": {
        "categories_covered": {
          "description": "DD categories with smells in this language",
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "files": {
          "description": "Number of files in this language",
          "minimum": 0,
          "type": "integer"
        },
        "lines": {
          "description": "Total lines in this language",
          "minimum": 0,
          "type": "integer"
        },
        "smell_count": {
          "description": "Total smells in this language",
          "minimum": 0,
          "type": "integer"
        }
      },
      "type": "object"
    },
    "smellEntry": {
      "description": "Individual code smell instance",
      "properties": {
        "code_snippet": {
          "description": "Code snippet containing the smell",
          "type": "string"
        },
        "column_end": {
          "description": "Ending column",
          "minimum": 0,
          "type": "integer"
        },
        "column_start": {
          "description": "Starting column",
          "minimum": 0,
          "type": "integer"
        },
        "dd_category": {
          "description": "DD category (e.g., error_handling, api_design, security)",
          "type": "string"
        },
        "dd_smell_id": {
          "description": "DD smell type code (e.g., D1_EMPTY_CATCH, H2_LONG_PARAM_LIST)",
          "type": "string"
        },
        "line_end": {
          "description": "Ending line number",
          "minimum": 1,
          "type": "integer"
        },
        "line_start": {
          "description": "Starting line number",
          "minimum": 1,
          "type": "integer"
        },
        "message": {
          "description": "Smell description",
          "type": "string"
        },
        "rule_id": {
          "description": "Semgrep rule ID",
          "type": "string"
        },
        "severity": {
          "description": "Smell severity",
          "enum": [
            "CRITICAL",
            "HIGH",
            "MEDIUM",
            "LOW",
            "INFO"
          ],
          "type": "string"
        }
      },
      "required": [
        "rule_id",
        "line_start",
        "severity",
        "message"
      ],
      "type": "object"
    }
  },
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "description": "JSON schema for Semgrep static analysis output in Caldera envelope format",
  "properties": {
    "data": {
      "description": "Analysis results",
      "properties": {
        "analysis_duration_ms": {
          "description": "Analysis duration in milliseconds",
          "minimum": 0,
          "type": "integer"
        },
        "by_language": {
          "additionalProperties": {
            "$ref": "#/$defs/languageStats"
          },
          "description": "Statistics grouped by programming language",
          "type": "object"
        },
        "directories": {
          "description": "Per-directory smell statistics",
          "items": {
            "$ref": "#/$defs/directoryEntry"
          },
          "type": "array"
        },
        "files": {
          "description": "Per-file smell details",
          "items": {
            "$ref": "#/$defs/fileEntry"
          },
          "type": "array"
        },
        "rules_used": {
          "description": "List of Semgrep rules that matched findings",
          "items": {
            "type": "string"
          },
          "type": "array"
        },
        "summary": {
          "description": "Summary statistics",
          "properties": {
            "files_with_smells": {
              "description": "Number of files containing code smells",
              "minimum": 0,
              "type": "integer"
            },
            "smells_by_category": {
              "additionalProperties": {
                "minimum": 0,
                "type": "integer"
              },
              "description": "Smell counts by DD category",
              "type": "object"
            },
            "smells_by_severity": {
              "additionalProperties": {
                "minimum": 0,
                "type": "integer"
              },
              "description": "Smell counts by severity level",
              "type": "object"
            },
            "smells_by_type": {
              "additionalProperties": {
                "minimum": 0,
                "type": "integer"
              },
              "description": "Smell counts by DD smell type code",
              "type": "object"
            },
            "total_directories": {
              "description": "Total number of directories",
              "minimum": 0,
              "type": "integer"
            },
            "total_files": {
              "description": "Total number of files analyzed",
              "minimum": 0,
              "type": "integer"
            },
            "total_lines": {
              "description": "Total lines of code analyzed",
              "minimum": 0,
              "type": "integer"
            },
            "total_smells": {
              "description": "Total number of code smells found",
              "minimum": 0,
              "type": "integer"
            }
          },
          "type": "object"
        },
        "tool": {
          "const": "semgrep",
          "description": "Tool identifier",
          "type": "string"
        },
        "tool_version": {
          "description": "Version of semgrep used",
          "type": "string"
        }
      },
      "required": [
        "tool",
        "tool_version",
        "summary",
        "files"
      ],
      "type": "object"
    },
    "metadata": {
      "description": "Envelope metadata for orchestrator integration",
      "properties": {
        "branch": {
          "description": "Git branch analyzed",
          "type": "string"
        },
        "commit": {
          "description": "Git commit SHA (40 hex characters)",
          "pattern": "^[0-9a-f]{40}$",
          "type": "string"
        },
        "repo_id": {
          "description": "Repository identifier from orchestrator",
          "format": "uuid",
          "type": "string"
        },
        "run_id": {
          "description": "Unique run identifier from orchestrator",
          "format": "uuid",
          "type": "string"
        },
        "schema_version": {
          "const": "1.0.0",
          "description": "Schema version (semver format)",
          "type": "string"
        },
        "timestamp": {
          "description": "ISO 8601 timestamp of when the analysis was generated",
          "format": "date-time",
          "type": "string"
        },
        "tool_name": {
          "const": "semgrep",
          "description": "Tool identifier",
          "type": "string"
        },
        "tool_version": {
          "description": "Version of semgrep used for analysis",
          "type": "string"
        }
      },
      "required": [
        "tool_name",
        "tool_version",
        "run_id",
        "repo_id",
        "branch",
        "commit",
        "timestamp",
        "schema_version"
      ],
      "type": "object"
    }
  },
  "required": [
    "metadata",
    "data"
  ],
  "title": "Semgrep Code Smell Analysis Output (Envelope Format)",
  "type": "object"
}
