// XML External Entity (XXE) test cases for DevSkim evaluation
// Expected: DevSkim should detect insecure XML parsing

using System;
using System.IO;
using System.Xml;
using System.Xml.Linq;

namespace SecurityTests
{
    public class XxeVulnerability
    {
        // VULNERABLE: XmlDocument with DTD processing enabled (DS144436)
        public XmlDocument LoadXmlWithDtd(string xml)
        {
            var doc = new XmlDocument();
            doc.XmlResolver = new XmlUrlResolver();  // Enables external entity resolution
            doc.LoadXml(xml);
            return doc;
            // DevSkim should flag XmlResolver usage
        }

        // VULNERABLE: XmlReader with DTD processing
        public void ParseWithDtd(Stream xmlStream)
        {
            var settings = new XmlReaderSettings();
            settings.DtdProcessing = DtdProcessing.Parse;  // Enables DTD processing
            settings.XmlResolver = new XmlUrlResolver();

            using (var reader = XmlReader.Create(xmlStream, settings))
            {
                while (reader.Read()) { }
            }
            // DevSkim should flag DtdProcessing.Parse
        }

        // VULNERABLE: XmlTextReader (legacy, insecure by default)
        public void ParseWithXmlTextReader(string filename)
        {
            using (var reader = new XmlTextReader(filename))
            {
                // XmlTextReader is insecure by default
                while (reader.Read()) { }
            }
            // DevSkim should flag XmlTextReader
        }

        // VULNERABLE: XDocument with insecure loading options
        public XDocument LoadXDocument(string xml)
        {
            return XDocument.Parse(xml, LoadOptions.SetLineInfo);
            // May be flagged depending on context
        }

        // SAFE: XmlDocument with resolver disabled
        public XmlDocument LoadXmlSafe(string xml)
        {
            var doc = new XmlDocument();
            doc.XmlResolver = null;  // Disables external entity resolution
            doc.LoadXml(xml);
            return doc;
            // This should NOT be flagged
        }

        // SAFE: XmlReader with DTD processing prohibited
        public void ParseSafe(Stream xmlStream)
        {
            var settings = new XmlReaderSettings();
            settings.DtdProcessing = DtdProcessing.Prohibit;  // Secure default
            settings.XmlResolver = null;

            using (var reader = XmlReader.Create(xmlStream, settings))
            {
                while (reader.Read()) { }
            }
            // This should NOT be flagged
        }

        // SAFE: Secure XmlTextReader configuration
        public void ParseSecureTextReader(string filename)
        {
            using (var reader = new XmlTextReader(filename))
            {
                reader.DtdProcessing = DtdProcessing.Prohibit;
                reader.XmlResolver = null;
                while (reader.Read()) { }
            }
            // This should NOT be flagged after configuration
        }
    }
}
