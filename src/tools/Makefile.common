# Makefile.common - Shared configuration for Caldera tools
# Include this file in tool Makefiles: include ../Makefile.common

# =============================================================================
# Python Virtual Environment
# =============================================================================

VENV ?= .venv
VENV_READY ?= $(VENV)/.ready
PYTHON_VENV ?= $(VENV)/bin/python
PIP ?= $(VENV)/bin/pip

# Common venv setup rule
# Tools should depend on $(VENV_READY) for any target needing Python
$(VENV_READY): requirements.txt
	@if [ "$(SKIP_SETUP)" = "1" ]; then \
		if [ ! -f "$(VENV)/bin/activate" ]; then \
			echo "Venv missing at $(VENV); run make setup first."; \
			exit 1; \
		fi; \
		if [ -w "$(VENV)" ]; then touch $(VENV_READY); fi; \
	else \
		echo "Setting up Python virtual environment..."; \
		if [ ! -f "$(VENV)/bin/activate" ]; then python3 -m venv $(VENV); fi; \
		$(PIP) install --upgrade pip -q; \
		$(PIP) install -r requirements.txt -q; \
		if [ -w "$(VENV)" ]; then touch $(VENV_READY); fi; \
	fi

# =============================================================================
# Orchestrator Variables (shared across all tools)
# =============================================================================

# Run identifiers - auto-generated UUIDs if not provided
RUN_ID ?= $(shell uuidgen 2>/dev/null || python3 -c "import uuid; print(uuid.uuid4())")
REPO_ID ?= $(shell uuidgen 2>/dev/null || python3 -c "import uuid; print(uuid.uuid4())")

# Output directories
OUTPUT_DIR ?= outputs/$(RUN_ID)
EVAL_OUTPUT_DIR ?= evaluation/results

# Git metadata
BRANCH ?= main
TIMESTAMP ?= $(shell date -u +%Y-%m-%dT%H:%M:%SZ)

# COMMIT is tool-specific since REPO_PATH varies - tools should define:
#   COMMIT ?= $(shell git -C $(REPO_PATH) rev-parse HEAD 2>/dev/null || echo "")

# LLM model configuration (default: sonnet)
LLM_MODEL ?= sonnet

# =============================================================================
# Common Targets
# =============================================================================

# Test targets - tools can override test-quick with tool-specific paths
.PHONY: _common-test _common-test-quick _common-clean _common-clean-all

_common-test: $(VENV_READY)
	@echo "Running all tests..."
	@$(PYTHON_VENV) -m pytest tests/ -v --tb=short
	@echo "All tests complete!"

_common-test-quick: $(VENV_READY)
	@echo "Running quick tests..."
	@$(PYTHON_VENV) -m pytest tests/ -v --tb=short -x
	@echo "Quick tests complete!"

_common-clean:
	@echo "Cleaning generated files..."
	@rm -rf outputs/*
	@rm -rf $(EVAL_OUTPUT_DIR)/*
	@rm -rf .pytest_cache
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@echo "Clean complete!"

_common-clean-all: _common-clean
	rm -rf $(VENV)
