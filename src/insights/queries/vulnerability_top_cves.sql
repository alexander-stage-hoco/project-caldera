-- Top CVEs by severity for Caldera
-- Uses stg_trivy_vulnerabilities

SELECT
    v.vulnerability_id AS cve_id,
    v.severity,
    v.package_name,
    v.installed_version,
    v.fixed_version,
    v.title,
    v.cvss_score,
    v.fix_available
FROM stg_trivy_vulnerabilities v
WHERE v.run_pk = {{ run_pk }}
ORDER BY
    CASE v.severity
        WHEN 'CRITICAL' THEN 1
        WHEN 'HIGH' THEN 2
        WHEN 'MEDIUM' THEN 3
        WHEN 'LOW' THEN 4
        ELSE 5
    END,
    v.cvss_score DESC NULLS LAST,
    v.vulnerability_id
LIMIT {{ limit | default(20) }}
