-- Packages with vulnerabilities for Caldera
-- Uses stg_trivy_vulnerabilities

SELECT
    v.package_name,
    v.installed_version,
    COUNT(*) AS total_vulns,
    SUM(CASE WHEN v.severity = 'CRITICAL' THEN 1 ELSE 0 END) AS critical_count,
    SUM(CASE WHEN v.severity = 'HIGH' THEN 1 ELSE 0 END) AS high_count,
    SUM(CASE WHEN v.severity = 'MEDIUM' THEN 1 ELSE 0 END) AS medium_count,
    SUM(CASE WHEN v.severity = 'LOW' THEN 1 ELSE 0 END) AS low_count,
    SUM(CASE WHEN v.fix_available THEN 1 ELSE 0 END) AS fixable_count
FROM stg_trivy_vulnerabilities v
WHERE v.run_pk = {{ run_pk }}
GROUP BY v.package_name, v.installed_version
ORDER BY
    critical_count DESC,
    high_count DESC,
    total_vulns DESC
LIMIT {{ limit | default(15) }}
