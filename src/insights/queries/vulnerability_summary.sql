-- Vulnerability summary by severity for Caldera
-- Resolves trivy run_pk from any tool's collection

WITH run_map AS (
    SELECT tr_tool.run_pk AS trivy_run_pk
    FROM lz_tool_runs tr_source
    LEFT JOIN lz_tool_runs tr_tool
        ON tr_tool.collection_run_id = tr_source.collection_run_id
        AND tr_tool.tool_name = 'trivy'
    WHERE tr_source.run_pk = {{ run_pk }}
)
SELECT
    v.severity,
    COUNT(*) AS count,
    COUNT(DISTINCT v.package_name) AS affected_packages,
    COUNT(DISTINCT v.vulnerability_id) AS unique_cves
FROM stg_trivy_vulnerabilities v
WHERE v.run_pk = (SELECT trivy_run_pk FROM run_map)
GROUP BY v.severity
ORDER BY
    CASE v.severity
        WHEN 'CRITICAL' THEN 1
        WHEN 'HIGH' THEN 2
        WHEN 'MEDIUM' THEN 3
        WHEN 'LOW' THEN 4
        ELSE 5
    END
